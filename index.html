<!DOCTYPE html>
<html lang="af">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>Oostagri Leierskap</title>
    <meta name="description" content="Leierskapsterugvoer en -ontwikkeling vir Frikkie Oosthuizen & Seuns">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="./manifest.json">
    
    <!-- CDN Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
    
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f172a;
            color: #f8fafc;
            min-height: 100vh;
            min-height: 100dvh;
        }
        
        .font-display { font-family: 'DM Serif Display', Georgia, serif; }
        
        .safe-top { padding-top: max(env(safe-area-inset-top, 0px), 16px) !important; }
        .safe-bottom { padding-bottom: max(env(safe-area-inset-bottom, 0px), 16px) !important; }
        
        /* Gradient backgrounds */
        .bg-gradient-dark {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
        }
        .bg-gradient-card {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
        }
        .bg-gradient-gold {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .bg-gradient-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        /* Glass effect */
        .glass {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 0 12px rgba(245, 158, 11, 0); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-fade-in { animation: fadeInUp 0.4s ease-out forwards; }
        .animate-fade-in-delay-1 { animation: fadeInUp 0.4s ease-out 0.1s forwards; opacity: 0; }
        .animate-fade-in-delay-2 { animation: fadeInUp 0.4s ease-out 0.2s forwards; opacity: 0; }
        .animate-fade-in-delay-3 { animation: fadeInUp 0.4s ease-out 0.3s forwards; opacity: 0; }
        .animate-pulse-gold { animation: pulse-gold 2s ease-in-out infinite; }
        .animate-spin { animation: spin 1s linear infinite; }
        
        .skeleton {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        /* Rating stars */
        .star { transition: all 0.15s ease; cursor: pointer; }
        .star:hover { transform: scale(1.2); }
        .star-filled { color: #f59e0b; }
        .star-empty { color: #475569; }
        
        /* Progress ring */
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Input focus */
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #f59e0b !important;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
        }
        
        /* Prevent zoom on iOS */
        input, select, textarea { font-size: 16px !important; }
        
        /* Hide number input spinners */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <!-- Service Worker Registration -->
    <script>
        // Service Worker Update Kennisgewing
        window.swUpdateAvailable = false;
        window.swRegistration = null;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('SW geregistreer:', reg.scope);
                        window.swRegistration = reg;

                        // Kyk vir updates
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            if (newWorker) {
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // Nuwe weergawe beskikbaar
                                        window.swUpdateAvailable = true;
                                        window.dispatchEvent(new CustomEvent('swUpdateAvailable'));
                                    }
                                });
                            }
                        });

                        // Kyk ook vir bestaande waiting worker
                        if (reg.waiting) {
                            window.swUpdateAvailable = true;
                            window.dispatchEvent(new CustomEvent('swUpdateAvailable'));
                        }

                        // Periodieke update check (elke 60 minute)
                        setInterval(() => {
                            reg.update().catch(err => console.log('SW update check fout:', err));
                        }, 60 * 60 * 1000);
                    })
                    .catch(err => console.log('SW fout:', err));

                // Luister vir kontroleerder veranderinge
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    window.location.reload();
                });
            });
        }

        // Funksie om update toe te pas
        window.applySwUpdate = function() {
            if (window.swRegistration && window.swRegistration.waiting) {
                window.swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
            }
        };
    </script>
    
    <!-- Offline Queue -->
    <script>
        const OfflineQueue = {
            QUEUE_KEY: 'leierskap_offline_queue',
            add: (item, action = 'SUBMIT') => {
                const queue = JSON.parse(localStorage.getItem(OfflineQueue.QUEUE_KEY) || '[]');
                queue.push({ ...item, _queuedAt: Date.now(), _action: action });
                localStorage.setItem(OfflineQueue.QUEUE_KEY, JSON.stringify(queue));
            },
            getAll: () => JSON.parse(localStorage.getItem(OfflineQueue.QUEUE_KEY) || '[]'),
            remove: (queuedAt) => {
                const queue = OfflineQueue.getAll();
                localStorage.setItem(OfflineQueue.QUEUE_KEY, JSON.stringify(queue.filter(o => o._queuedAt !== queuedAt)));
            },
            clear: () => localStorage.removeItem(OfflineQueue.QUEUE_KEY),
            count: () => OfflineQueue.getAll().length
        };
        window.OfflineQueue = OfflineQueue;
    </script>
    
    <!-- SVG Icons -->
    <script>
        const Icons = {
            User: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('path', {key: 1, d: 'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'}),
                React.createElement('circle', {key: 2, cx: 12, cy: 7, r: 4})
            ]),
            Users: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('path', {key: 1, d: 'M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2'}),
                React.createElement('circle', {key: 2, cx: 9, cy: 7, r: 4}),
                React.createElement('path', {key: 3, d: 'M23 21v-2a4 4 0 0 0-3-3.87'}),
                React.createElement('path', {key: 4, d: 'M16 3.13a4 4 0 0 1 0 7.75'})
            ]),
            CheckCircle: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('path', {key: 1, d: 'M22 11.08V12a10 10 0 1 1-5.93-9.14'}),
                React.createElement('polyline', {key: 2, points: '22 4 12 14.01 9 11.01'})
            ]),
            Circle: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, className
            }, React.createElement('circle', {cx: 12, cy: 12, r: 10})),
            Star: ({size = 24, filled = false, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24',
                fill: filled ? 'currentColor' : 'none',
                stroke: 'currentColor', strokeWidth: 2, className
            }, React.createElement('polygon', {
                points: '12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2'
            })),
            ArrowLeft: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('line', {key: 1, x1: 19, y1: 12, x2: 5, y2: 12}),
                React.createElement('polyline', {key: 2, points: '12 19 5 12 12 5'})
            ]),
            ArrowRight: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('line', {key: 1, x1: 5, y1: 12, x2: 19, y2: 12}),
                React.createElement('polyline', {key: 2, points: '12 5 19 12 12 19'})
            ]),
            LogOut: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('path', {key: 1, d: 'M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4'}),
                React.createElement('polyline', {key: 2, points: '16 17 21 12 16 7'}),
                React.createElement('line', {key: 3, x1: 21, y1: 12, x2: 9, y2: 12})
            ]),
            Clock: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('circle', {key: 1, cx: 12, cy: 12, r: 10}),
                React.createElement('polyline', {key: 2, points: '12 6 12 12 16 14'})
            ]),
            BarChart: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('line', {key: 1, x1: 12, y1: 20, x2: 12, y2: 10}),
                React.createElement('line', {key: 2, x1: 18, y1: 20, x2: 18, y2: 4}),
                React.createElement('line', {key: 3, x1: 6, y1: 20, x2: 6, y2: 16})
            ]),
            Download: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('path', {key: 1, d: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'}),
                React.createElement('polyline', {key: 2, points: '7 10 12 15 17 10'}),
                React.createElement('line', {key: 3, x1: 12, y1: 15, x2: 12, y2: 3})
            ]),
            AlertCircle: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('circle', {key: 1, cx: 12, cy: 12, r: 10}),
                React.createElement('line', {key: 2, x1: 12, y1: 8, x2: 12, y2: 12}),
                React.createElement('line', {key: 3, x1: 12, y1: 16, x2: 12.01, y2: 16})
            ]),
            Wifi: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('path', {key: 1, d: 'M5 12.55a11 11 0 0 1 14.08 0'}),
                React.createElement('path', {key: 2, d: 'M1.42 9a16 16 0 0 1 21.16 0'}),
                React.createElement('path', {key: 3, d: 'M8.53 16.11a6 6 0 0 1 6.95 0'}),
                React.createElement('line', {key: 4, x1: 12, y1: 20, x2: 12.01, y2: 20})
            ]),
            WifiOff: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('line', {key: 1, x1: 1, y1: 1, x2: 23, y2: 23}),
                React.createElement('path', {key: 2, d: 'M16.72 11.06A10.94 10.94 0 0 1 19 12.55'}),
                React.createElement('path', {key: 3, d: 'M5 12.55a10.94 10.94 0 0 1 5.17-2.39'}),
                React.createElement('path', {key: 4, d: 'M10.71 5.05A16 16 0 0 1 22.58 9'}),
                React.createElement('path', {key: 5, d: 'M1.42 9a15.91 15.91 0 0 1 4.7-2.88'}),
                React.createElement('path', {key: 6, d: 'M8.53 16.11a6 6 0 0 1 6.95 0'}),
                React.createElement('line', {key: 7, x1: 12, y1: 20, x2: 12.01, y2: 20})
            ]),
            Shield: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, React.createElement('path', {d: 'M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z'})),
            Clipboard: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('path', {key: 1, d: 'M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2'}),
                React.createElement('rect', {key: 2, x: 8, y: 2, width: 8, height: 4, rx: 1, ry: 1})
            ]),
            Home: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('path', {key: 1, d: 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z'}),
                React.createElement('polyline', {key: 2, points: '9 22 9 12 15 12 15 22'})
            ]),
            Refresh: ({size = 24, className = ''}) => React.createElement('svg', {
                width: size, height: size, viewBox: '0 0 24 24', fill: 'none',
                stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round',
                className
            }, [
                React.createElement('polyline', {key: 1, points: '23 4 23 10 17 10'}),
                React.createElement('path', {key: 2, d: 'M20.49 15a9 9 0 1 1-2.12-9.36L23 10'})
            ])
        };
        window.Icons = Icons;
    </script>
    
    <!-- Main React App -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, Component } = React;

        // ============================================
        // KONFIGURASIE
        // ============================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbx2pfmwarOKuA4q6klod03k7-mL0oB1Z0Eeq0wrQn84h24nRPUBh2jbp2jwosbDmBEO/exec';
        const APP_VERSION = '1.3.0';
        const CACHE_KEY = 'leierskap_cache';
        const USER_KEY = 'leierskap_user';
        const DASHBOARD_CACHE_KEY = 'leierskap_dashboard_cache';
        
        // Die 7 evaluasievrae
        const QUESTIONS = [
            {
                id: 'q1',
                title: 'Aanspreeklikheid en Eienaarskap',
                description: 'In watter mate neem die bestuurder volle verantwoordelikheid vir die uitkomste, standaarde, beloftes en teikens van sy/haar afdeling?',
                hint: 'Let op konsekwentheid, opvolging en bereidheid om verantwoordelikheid te aanvaar sonder verskonings.'
            },
            {
                id: 'q2',
                title: 'Strategiese Fokus en Prioriteitsbestuur',
                description: 'Hoe doeltreffend bestuur die persoon prioriteite, beplanning en uitvoering in lyn met die onderneming se strategie?',
                hint: 'Let op fokus, opvolging, implementering en die vermoë om te onderskei tussen dringend en belangrik.'
            },
            {
                id: 'q3',
                title: 'Kommunikasie en Samewerking',
                description: 'Hoe duidelik, betyds en oplossingsgerig kommunikeer die bestuurder met spanlede, ander afdelings en topbestuur?',
                hint: 'Let op professionele toon, luistervaardigheid, samewerking en die vermoë om vertroue te bou.'
            },
            {
                id: 'q4',
                title: 'Leierskapgedrag',
                description: 'Hoe tree die persoon op as leier — in terme van voorbeeld stel, konsekwentheid, karakter en stabiliteit?',
                hint: 'Let op gedrag onder druk en die vermoë om rigting en stabiliteit te bied.'
            },
            {
                id: 'q5',
                title: 'Kwaliteit van Besluite',
                description: 'In watter mate word besluite geneem op grond van kwaliteitsdata, risiko-insig en langtermynvolhoubaarheid?',
                hint: 'Let op oordeel, analitiese denke en vooruitbeplanning.'
            },
            {
                id: 'q6',
                title: 'Verbetering en Leer',
                description: 'Hoe sterk is die bestuurder se ingesteldheid tot voortdurende verbetering (Kaizen) en professionele groei?',
                hint: 'Let op selfrefleksie, bereidheid om terugvoer te ontvang, en volgehoue verbetering.'
            },
            {
                id: 'q7',
                title: 'Familiewaardes en Kultuurbelynheid',
                description: 'Hoe konsekwent reflekteer die bestuurder die familie se waardes in sy/haar optrede en leierskap?',
                hint: 'Let op integriteit, respek, lojaliteit, rentmeesterskap, samewerking, nederigheid en langtermyn-denke.'
            }
        ];
        
        const GRADE_LABELS = {
            1: 'Voldoen nie aan vereistes',
            2: 'Gedeeltelik voldoen',
            3: 'Voldoen aan vereistes',
            4: 'Oorskry vereistes',
            5: 'Uitsonderlik'
        };

        // ============================================
        // MELKSTALBESTUURDER EVALUASIE VRAE
        // ============================================
        const MELKSTAL_SECTIONS = [
            {
                id: 'kuddebestuur',
                title: 'Kuddebestuur en Melkbedrywighede',
                questions: [
                    {
                        id: 'ms1',
                        type: 'yesnoNA',
                        title: 'Kalfsterstesyfer onder 5% vir die maand?',
                        hint: 'Berekening handleiding: Aantal kalwers 3 maande en jonger moet 5%'
                    },
                    {
                        id: 'ms2',
                        type: 'text',
                        title: 'Rede vir afwyking (indien van toepassing)',
                        conditional: 'ms1:Nee'
                    },
                    {
                        id: 'ms3',
                        type: 'yesno',
                        title: 'Koeisterftes vir maand minder as 5?'
                    },
                    {
                        id: 'ms4',
                        type: 'choice',
                        title: 'Koeie in melk maar nie gemelk nie volgens Delpro (uitgesluit kalf koeie)',
                        options: ['0 - 2', '3 - 5', '6+']
                    },
                    {
                        id: 'ms5',
                        type: 'choice',
                        title: 'Koeie in melk 90 dae plus sonder KI datum',
                        options: ['Geen', '1 - 5', '6 - 10', '11+']
                    },
                    {
                        id: 'ms6',
                        type: 'choice',
                        title: 'Koeie in melk 180 dae plus en nie dragtig bevestig',
                        options: ['Geen', '1 - 5', '6 - 15', '15+']
                    },
                    {
                        id: 'ms7',
                        type: 'choice',
                        title: 'Koeie oor verwagte kalf datum vir 7 dae en meer',
                        options: ['Geen', '1 - 5', '6+']
                    },
                    {
                        id: 'ms8',
                        type: 'choice',
                        title: 'Aantal koeie in siekspan vir 14+ dae?',
                        options: ['Geen', 'Een en meer']
                    },
                    {
                        id: 'ms9',
                        type: 'text',
                        title: 'Rede vir siek koeie langer as 14 dae in siek span?',
                        conditional: 'ms8:Een en meer'
                    },
                    {
                        id: 'ms10',
                        type: 'yesno',
                        title: 'Gesondheid-, kalf en paringsplan opgestel en geïmplementeer?'
                    },
                    {
                        id: 'ms11',
                        type: 'yesno',
                        title: 'Inentingsplan op datum en voorraad medikasie voldoende?'
                    },
                    {
                        id: 'ms12',
                        type: 'yesno',
                        title: 'Somatiese seltelling gemiddeld < 250 000?'
                    },
                    {
                        id: 'ms13',
                        type: 'yesno',
                        title: 'Bakterietelling < 50?'
                    },
                    {
                        id: 'ms14',
                        type: 'yesno',
                        title: 'Rekordhouding (Delpro/Kalfregister/Verslag) volledig en ingedien voor 5de?'
                    }
                ]
            },
            {
                id: 'instandhouding',
                title: 'Instandhouding',
                questions: [
                    {
                        id: 'ms15',
                        type: 'yesno',
                        title: 'Is toerusting, parte en medikasie gesorteer?'
                    },
                    {
                        id: 'ms16',
                        type: 'yesno',
                        title: 'Is toerusting, parte en medikasie maandelikse voorraad getel?'
                    },
                    {
                        id: 'ms17',
                        type: 'choice',
                        title: 'Afkoelers wat nie werk nie',
                        options: ['0 - 1', '2 - 3', '4+']
                    },
                    {
                        id: 'ms18',
                        type: 'choice',
                        title: 'Aantal waterpype wat lek',
                        options: ['Geen', '1 - 2', '3+']
                    },
                    {
                        id: 'ms19',
                        type: 'multirating',
                        title: 'Hoe sal jy die algemene netheid van die melkstal, kantoor en perseel gradeer?',
                        items: [
                            'Netheid van die melkstal se senter',
                            'Netheid van die kantoor',
                            'Netheid van die kompressor, was en seep kamer',
                            'Netheid generator kamer',
                            'Netheid rondom die melkstal',
                            'Netheid en toestand van bakkie onder bestuurder se toesig'
                        ],
                        labels: ['Onaanvaarbaar', 'Swak', 'Aanvaarbaar', 'Goed', 'Uitstekend']
                    }
                ]
            },
            {
                id: 'moraal',
                title: 'Moraal & Gesondheid',
                questions: [
                    {
                        id: 'ms20',
                        type: 'rating',
                        title: 'Watter vlak van kultuurbou het die bestuurder getoon hierdie maand?',
                        labels: [
                            'Negatief - Trek spanenergie af',
                            'Neutraal - Beperk tot nie sake',
                            'Neutraal - Hou balans, maar bou nie aktief kultuur nie',
                            'Positief - Motiveer en ondersteun spanlede',
                            'Inspirerend - Stel hoë standaard, help ander om te groei'
                        ]
                    },
                    {
                        id: 'ms21',
                        type: 'text',
                        title: 'Voorbeeld van gedrag wat hierdie gradering ondersteun?'
                    },
                    {
                        id: 'ms22',
                        type: 'multirating',
                        title: 'Spanmoraal, Bereidwilligheid en Algemene Gesondheid gedurende die maand?',
                        items: [
                            'Algemene moraal van span',
                            'Bereidwilligheid om te help en te lê',
                            'Samewerking en kommunikasie'
                        ],
                        labels: ['Baie Swak', 'Swak', 'Gemiddeld', 'Goed', 'Uitstekend']
                    },
                    {
                        id: 'ms23',
                        type: 'text',
                        title: 'Enige opmerking wat gradering van 1 of 2 ondersteun'
                    }
                ]
            },
            {
                id: 'opmerkings',
                title: 'Opmerkings en Aksies',
                questions: [
                    {
                        id: 'ms24',
                        type: 'textarea',
                        title: 'Kommentaar / Opmerkings van bestuurder'
                    },
                    {
                        id: 'ms25',
                        type: 'textarea',
                        title: 'Aksies of verbeteringsplan vir volgende maand'
                    }
                ]
            }
        ];

        // Flatten all questions for easy access
        const MELKSTAL_QUESTIONS = MELKSTAL_SECTIONS.flatMap(s => s.questions);

        // ============================================
        // ERROR BOUNDARY
        // ============================================
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error('App fout:', error, errorInfo);
            }

            handleReload = () => {
                window.location.reload();
            };

            handleClearAndReload = () => {
                localStorage.removeItem(USER_KEY);
                localStorage.removeItem(CACHE_KEY);
                window.location.reload();
            };

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen min-h-[100dvh] flex flex-col items-center justify-center p-6 bg-gradient-dark safe-top safe-bottom">
                            <div className="text-center max-w-sm">
                                <div className="w-20 h-20 mx-auto mb-6 rounded-2xl bg-red-500/20 flex items-center justify-center">
                                    <Icons.AlertCircle size={40} className="text-red-400" />
                                </div>
                                <h1 className="font-display text-2xl text-white mb-4">Iets het fout gegaan</h1>
                                <p className="text-slate-400 mb-8">
                                    Die app het 'n onverwagte fout teëgekom. Probeer om die bladsy te herlaai.
                                </p>
                                <div className="space-y-3">
                                    <button
                                        onClick={this.handleReload}
                                        className="w-full py-4 bg-gradient-gold text-slate-900 rounded-xl font-bold hover:opacity-90 transition"
                                    >
                                        Herlaai Bladsy
                                    </button>
                                    <button
                                        onClick={this.handleClearAndReload}
                                        className="w-full py-3 bg-slate-800 text-slate-300 rounded-xl hover:bg-slate-700 transition text-sm"
                                    >
                                        Maak data skoon en herlaai
                                    </button>
                                </div>
                                <p className="text-slate-500 text-sm mt-6">v{APP_VERSION}</p>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // ============================================
        // API HELPERS
        // ============================================
        const apiCall = async (action, params = {}) => {
            const url = new URL(API_URL);
            url.searchParams.append('action', action);
            Object.entries(params).forEach(([key, value]) => {
                if (typeof value === 'object') {
                    url.searchParams.append(key, JSON.stringify(value));
                } else {
                    url.searchParams.append(key, value);
                }
            });

            try {
                const response = await fetch(url.toString());
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                return { success: false, error: 'Netwerkfout', offline: true };
            }
        };

        // ============================================
        // CSV EXPORT HELPER
        // ============================================
        const exportToCSV = (data, filename) => {
            if (!data || data.length === 0) {
                alert('Geen data om te eksporteer nie');
                return;
            }

            // Get headers from first object
            const headers = Object.keys(data[0]);

            // Build CSV content
            const csvRows = [];
            csvRows.push(headers.join(','));

            data.forEach(row => {
                const values = headers.map(header => {
                    let val = row[header];
                    if (val === null || val === undefined) val = '';
                    if (typeof val === 'object') val = JSON.stringify(val);
                    // Escape quotes and wrap in quotes if contains comma
                    val = String(val).replace(/"/g, '""');
                    if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                        val = `"${val}"`;
                    }
                    return val;
                });
                csvRows.push(values.join(','));
            });

            const csvContent = csvRows.join('\n');
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };

        // Format evaluation data for export
        const formatEvaluationsForExport = (evaluations, includeComments = true) => {
            return evaluations.map(e => {
                const row = {
                    'Datum': e.submittedAt ? new Date(e.submittedAt).toLocaleDateString('af-ZA') : '',
                    'Evalueerder': e.evaluatorName || '',
                    'Onderwerp': e.subjectName || '',
                    'Gemiddeld': e.averageGrade ? e.averageGrade.toFixed(1) : ''
                };

                // Add individual question grades
                QUESTIONS.forEach((q, i) => {
                    row[`V${i+1} Telling`] = e.grades?.[q.id] || '';
                    if (includeComments) {
                        row[`V${i+1} Opmerking`] = e.comments?.[q.id] || '';
                    }
                });

                return row;
            });
        };
        
        // ============================================
        // HOOF APP
        // ============================================
        const App = () => {
            // State
            const [screen, setScreen] = useState('login');
            const [currentUser, setCurrentUser] = useState(() => {
                const saved = localStorage.getItem(USER_KEY);
                return saved ? JSON.parse(saved) : null;
            });
            const [currentCycle, setCurrentCycle] = useState(null);
            const [subjects, setSubjects] = useState([]);
            const [completedSubjects, setCompletedSubjects] = useState([]);
            const [selectedSubject, setSelectedSubject] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [isLoading, setIsLoading] = useState(false);
            const [isInitializing, setIsInitializing] = useState(true);
            const [error, setError] = useState(null);
            const [toast, setToast] = useState(null);
            
            // Coach state
            const [coachData, setCoachData] = useState(null);
            const [selectedPersonDetail, setSelectedPersonDetail] = useState(null);

            // Evaluation history state
            const [myEvaluations, setMyEvaluations] = useState([]);
            const [selectedEvaluationForEdit, setSelectedEvaluationForEdit] = useState(null);

            // Middle management (Melkstalbestuurder) state
            const [subordinates, setSubordinates] = useState([]);
            const [completedSubordinates, setCompletedSubordinates] = useState([]);
            const [currentMonth, setCurrentMonth] = useState(() => {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            });
            const [myMelkstalEvaluations, setMyMelkstalEvaluations] = useState([]);
            const [selectedMelkstalSubject, setSelectedMelkstalSubject] = useState(null);

            // Service Worker update state
            const [swUpdateAvailable, setSwUpdateAvailable] = useState(window.swUpdateAvailable || false);
            
            // Online/Offline tracking
            useEffect(() => {
                const handleOnline = () => {
                    setIsOnline(true);
                    syncOfflineQueue();
                };
                const handleOffline = () => setIsOnline(false);

                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);

                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // Service Worker update listener
            useEffect(() => {
                const handleSwUpdate = () => setSwUpdateAvailable(true);
                window.addEventListener('swUpdateAvailable', handleSwUpdate);
                return () => window.removeEventListener('swUpdateAvailable', handleSwUpdate);
            }, []);

            // Handle SW update
            const handleSwUpdate = () => {
                if (window.applySwUpdate) {
                    window.applySwUpdate();
                }
            };
            
            // Auto-login check
            useEffect(() => {
                const initApp = async () => {
                    if (currentUser) {
                        await loadInitialData(currentUser);
                    }
                    setIsInitializing(false);
                };
                initApp();
            }, []);
            
            // Sync offline queue
            const syncOfflineQueue = async () => {
                const queue = OfflineQueue.getAll();
                for (const item of queue) {
                    try {
                        const result = await apiCall('submitEvaluation', { data: item });
                        if (result.success) {
                            OfflineQueue.remove(item._queuedAt);
                        }
                    } catch (e) {
                        break;
                    }
                }
            };
            
            // Load and apply cached dashboard data
            const loadCachedData = (userCode) => {
                try {
                    const cacheKey = `${DASHBOARD_CACHE_KEY}_${userCode}`;
                    const cached = localStorage.getItem(cacheKey);
                    if (cached) {
                        const data = JSON.parse(cached);
                        // Check if cache is less than 24 hours old
                        if (data.timestamp && (Date.now() - data.timestamp) < 24 * 60 * 60 * 1000) {
                            return data;
                        }
                    }
                } catch (e) {
                    console.log('Cache lees fout:', e);
                }
                return null;
            };

            // Save dashboard data to cache
            const saveCacheData = (userCode, data) => {
                try {
                    const cacheKey = `${DASHBOARD_CACHE_KEY}_${userCode}`;
                    localStorage.setItem(cacheKey, JSON.stringify({
                        ...data,
                        timestamp: Date.now()
                    }));
                } catch (e) {
                    console.log('Cache stoor fout:', e);
                }
            };

            // Apply data to state
            const applyDashboardData = (data) => {
                if (data.cycle) setCurrentCycle(data.cycle);
                if (data.currentMonth) setCurrentMonth(data.currentMonth);
                if (data.subjects) setSubjects(data.subjects);
                if (data.completedSubjects) setCompletedSubjects(data.completedSubjects);
                if (data.myEvaluations) setMyEvaluations(data.myEvaluations);
                if (data.subordinates) setSubordinates(data.subordinates);
                if (data.completedSubordinates) setCompletedSubordinates(data.completedSubordinates);
                if (data.myMelkstalEvaluations) setMyMelkstalEvaluations(data.myMelkstalEvaluations);
                if (data.coachData) setCoachData(data.coachData);
            };

            // Load initial data - optimized with caching
            const loadInitialData = async (user = null, forceRefresh = false) => {
                const activeUser = user || currentUser;
                if (!activeUser) {
                    setError('Geen gebruiker aangemeld');
                    return;
                }

                // Step 1: Load cached data immediately (instant UI)
                const cachedData = loadCachedData(activeUser.code);
                if (cachedData && !forceRefresh) {
                    applyDashboardData(cachedData);
                    setScreen('dashboard');
                    // Continue to fetch fresh data in background
                }

                setIsLoading(true);
                try {
                    // Step 2: Fetch fresh data with single API call
                    const now = new Date();
                    const monthId = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

                    const result = await apiCall('getInitialData', {
                        userId: activeUser.code,
                        role: activeUser.role,
                        monthId: monthId
                    });

                    if (result.success) {
                        // Build data object
                        const freshData = {
                            cycle: result.cycle,
                            currentMonth: monthId,
                            subjects: result.subjects || [],
                            completedSubjects: result.completedSubjects || [],
                            myEvaluations: result.myEvaluations || [],
                            subordinates: result.subordinates || [],
                            completedSubordinates: result.completedSubordinates || [],
                            myMelkstalEvaluations: result.myMelkstalEvaluations || [],
                            coachData: result.coachData || null
                        };

                        // Step 3: Apply fresh data and cache it
                        applyDashboardData(freshData);
                        saveCacheData(activeUser.code, freshData);
                        setScreen('dashboard');
                    } else if (result.noCycle) {
                        setError('Geen oop evaluasiesiklus');
                        setScreen('noCycle');
                    } else {
                        // If API fails but we have cache, stay on dashboard
                        if (cachedData) {
                            console.log('API fout, gebruik cached data');
                        } else {
                            console.error('Data fout:', result);
                            setError(result.error || 'Kon nie data laai nie');
                        }
                    }
                } catch (e) {
                    console.error('loadInitialData fout:', e);
                    // If error but we have cache, stay on dashboard
                    if (!cachedData) {
                        setError('Kon nie data laai nie: ' + e.message);
                    }
                } finally {
                    setIsLoading(false);
                }
            };
            
            // Login handler
            const handleLogin = async (code) => {
                setIsLoading(true);
                setError(null);
                
                const result = await apiCall('login', { code });
                
                if (result.success) {
                    setCurrentUser(result.user);
                    localStorage.setItem(USER_KEY, JSON.stringify(result.user));
                    await loadInitialData(result.user);
                } else {
                    setError(result.error || 'Ongeldige kode');
                }
                
                setIsLoading(false);
            };
            
            // Logout handler
            const handleLogout = () => {
                setCurrentUser(null);
                setCurrentCycle(null);
                setSubjects([]);
                setCompletedSubjects([]);
                setCoachData(null);
                localStorage.removeItem(USER_KEY);
                setScreen('login');
            };
            
            // Submit evaluation
            const handleSubmitEvaluation = async (evalData) => {
                setIsLoading(true);

                const fullData = {
                    ...evalData,
                    cycleId: currentCycle.id,
                    evaluatorCode: currentUser.code,
                    evaluatorName: currentUser.name,
                    subjectCode: selectedSubject.id,
                    subjectName: selectedSubject.name
                };

                if (isOnline) {
                    const result = await apiCall('submitEvaluation', { data: fullData });
                    if (result.success) {
                        setCompletedSubjects([...completedSubjects, selectedSubject.id]);
                        showToast('Evaluasie suksesvol gestoor!', 'success');
                        // Refresh evaluations list
                        const evalsResult = await apiCall('getUserEvaluations', {
                            userId: currentUser.code,
                            cycleId: currentCycle.id
                        });
                        if (evalsResult.success) {
                            setMyEvaluations(evalsResult.evaluations || []);
                        }
                        setScreen('success');
                    } else {
                        showToast(result.error || 'Kon nie stoor nie', 'error');
                    }
                } else {
                    OfflineQueue.add(fullData);
                    setCompletedSubjects([...completedSubjects, selectedSubject.id]);
                    showToast('Gestoor vir later sinkronisering', 'warning');
                    setScreen('success');
                }

                setIsLoading(false);
            };

            // Update existing evaluation
            const handleUpdateEvaluation = async (evalData) => {
                setIsLoading(true);

                const fullData = {
                    ...evalData,
                    evaluationId: selectedEvaluationForEdit.id,
                    cycleId: currentCycle.id,
                    evaluatorCode: currentUser.code,
                    subjectCode: selectedSubject.id
                };

                if (isOnline) {
                    const result = await apiCall('updateEvaluation', { data: fullData });
                    if (result.success) {
                        showToast('Evaluasie suksesvol opgedateer!', 'success');
                        // Refresh evaluations list
                        const evalsResult = await apiCall('getUserEvaluations', {
                            userId: currentUser.code,
                            cycleId: currentCycle.id
                        });
                        if (evalsResult.success) {
                            setMyEvaluations(evalsResult.evaluations || []);
                        }
                        setSelectedEvaluationForEdit(null);
                        setScreen('myEvaluations');
                    } else {
                        showToast(result.error || 'Kon nie opdateer nie', 'error');
                    }
                } else {
                    showToast('Jy moet aanlyn wees om te wysig', 'error');
                }

                setIsLoading(false);
            };

            // Submit melkstal evaluation
            const handleSubmitMelkstalEvaluation = async (evalData) => {
                setIsLoading(true);

                const fullData = {
                    ...evalData,
                    monthId: currentMonth,
                    evaluatorCode: currentUser.code,
                    evaluatorName: currentUser.name,
                    subjectCode: selectedMelkstalSubject.id,
                    subjectName: selectedMelkstalSubject.name,
                    subjectLocation: selectedMelkstalSubject.location || ''
                };

                if (isOnline) {
                    const result = await apiCall('submitMelkstalEvaluation', { data: fullData });
                    if (result.success) {
                        setCompletedSubordinates([...completedSubordinates, selectedMelkstalSubject.id]);
                        showToast('Evaluasie suksesvol gestoor!', 'success');
                        // Refresh melkstal evaluations list
                        const evalsResult = await apiCall('getUserMelkstalEvaluations', {
                            userId: currentUser.code
                        });
                        if (evalsResult.success) {
                            setMyMelkstalEvaluations(evalsResult.evaluations || []);
                        }
                        setScreen('melkstalSuccess');
                    } else {
                        showToast(result.error || 'Kon nie stoor nie', 'error');
                    }
                } else {
                    showToast('Jy moet aanlyn wees om melkstal evaluasies te stoor', 'error');
                }

                setIsLoading(false);
            };

            // Toast helper
            const showToast = (message, type = 'info') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 3000);
            };
            
            // Start evaluation
            const startEvaluation = (subject) => {
                setSelectedSubject(subject);
                setScreen('evaluation');
            };

            // Start melkstal evaluation
            const startMelkstalEvaluation = (subordinate) => {
                setSelectedMelkstalSubject(subordinate);
                setScreen('melkstalEvaluation');
            };

            // Progress calculation
            const getProgress = () => {
                const total = subjects.length;
                const done = completedSubjects.length;
                return { total, done, percentage: total > 0 ? Math.round((done / total) * 100) : 0 };
            };
            
            // ============================================
            // RENDER
            // ============================================

            // Wys laai spinner tydens initialisering
            if (isInitializing) {
                return (
                    <div className="min-h-screen min-h-[100dvh] bg-gradient-dark flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-12 h-12 border-3 border-amber-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-slate-400">Laai...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen min-h-[100dvh] bg-gradient-dark">
                    {/* Offline Banner */}
                    {!isOnline && (
                        <div className="fixed top-0 left-0 right-0 bg-amber-600 text-white text-center py-2 text-sm font-medium z-50 safe-top">
                            <Icons.WifiOff size={16} className="inline mr-2" />
                            Geen internetverbinding — werk vanlyn
                        </div>
                    )}

                    {/* SW Update Banner */}
                    {swUpdateAvailable && (
                        <div className="fixed bottom-0 left-0 right-0 bg-emerald-600 text-white p-4 z-50 safe-bottom animate-fade-in">
                            <div className="flex items-center justify-between max-w-lg mx-auto">
                                <div className="flex items-center gap-3">
                                    <Icons.Refresh size={20} />
                                    <span className="text-sm font-medium">Nuwe weergawe beskikbaar!</span>
                                </div>
                                <button
                                    onClick={handleSwUpdate}
                                    className="px-4 py-2 bg-white text-emerald-700 rounded-lg font-bold text-sm hover:bg-emerald-50 transition"
                                >
                                    Opdateer
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Toast */}
                    {toast && (
                        <div className={`fixed top-4 left-4 right-4 p-4 rounded-xl text-white text-center z-50 animate-fade-in ${
                            toast.type === 'success' ? 'bg-emerald-600' :
                            toast.type === 'error' ? 'bg-red-600' :
                            toast.type === 'warning' ? 'bg-amber-600' : 'bg-slate-700'
                        }`}>
                            {toast.message}
                        </div>
                    )}
                    
                    {/* Screens */}
                    {screen === 'login' && (
                        <LoginScreen onLogin={handleLogin} isLoading={isLoading} error={error} />
                    )}
                    
                    {screen === 'noCycle' && (
                        <NoCycleScreen user={currentUser} onLogout={handleLogout} />
                    )}
                    
                    {screen === 'dashboard' && currentUser?.role !== 'coach' && (
                        <DashboardScreen
                            user={currentUser}
                            cycle={currentCycle}
                            subjects={subjects}
                            completedSubjects={completedSubjects}
                            progress={getProgress()}
                            subordinates={subordinates}
                            completedSubordinates={completedSubordinates}
                            currentMonth={currentMonth}
                            onStartEvaluation={startEvaluation}
                            onStartMelkstalEvaluation={startMelkstalEvaluation}
                            onLogout={handleLogout}
                            onRefresh={loadInitialData}
                            isLoading={isLoading}
                            onViewHistory={() => setScreen('myEvaluations')}
                            historyCount={myEvaluations.length + myMelkstalEvaluations.length}
                        />
                    )}
                    
                    {screen === 'dashboard' && currentUser?.role === 'coach' && (
                        <CoachDashboard
                            user={currentUser}
                            cycle={currentCycle}
                            data={coachData}
                            onSelectPerson={(person) => {
                                setSelectedPersonDetail(person);
                                setScreen('coachDetail');
                            }}
                            onLogout={handleLogout}
                            onRefresh={loadInitialData}
                            isLoading={isLoading}
                        />
                    )}
                    
                    {screen === 'evaluation' && (
                        <EvaluationScreen
                            subject={selectedSubject}
                            isSelf={selectedSubject?.id === currentUser?.code}
                            onSubmit={handleSubmitEvaluation}
                            onBack={() => setScreen('dashboard')}
                            isLoading={isLoading}
                        />
                    )}

                    {screen === 'melkstalEvaluation' && selectedMelkstalSubject && (
                        <MelkstalEvaluationScreen
                            subject={selectedMelkstalSubject}
                            currentMonth={currentMonth}
                            onSubmit={handleSubmitMelkstalEvaluation}
                            onBack={() => {
                                setSelectedMelkstalSubject(null);
                                setScreen('dashboard');
                            }}
                            isLoading={isLoading}
                        />
                    )}

                    {screen === 'melkstalSuccess' && (
                        <SuccessScreen
                            subject={selectedMelkstalSubject}
                            onContinue={() => {
                                setSelectedMelkstalSubject(null);
                                setScreen('dashboard');
                            }}
                        />
                    )}

                    {screen === 'success' && (
                        <SuccessScreen
                            subject={selectedSubject}
                            onContinue={() => setScreen('dashboard')}
                        />
                    )}
                    
                    {screen === 'coachDetail' && (
                        <CoachDetailScreen
                            person={selectedPersonDetail}
                            cycle={currentCycle}
                            user={currentUser}
                            onBack={() => {
                                setSelectedPersonDetail(null);
                                setScreen('dashboard');
                            }}
                        />
                    )}

                    {screen === 'myEvaluations' && (
                        <MyEvaluationsScreen
                            evaluations={myEvaluations}
                            onBack={() => setScreen('dashboard')}
                            onEdit={(evaluation) => {
                                setSelectedEvaluationForEdit(evaluation);
                                setSelectedSubject({ id: evaluation.subjectId, name: evaluation.subjectName });
                                setScreen('editEvaluation');
                            }}
                            onView={(evaluation) => {
                                setSelectedEvaluationForEdit(evaluation);
                                setScreen('viewEvaluation');
                            }}
                        />
                    )}

                    {screen === 'viewEvaluation' && selectedEvaluationForEdit && (
                        <ViewEvaluationScreen
                            evaluation={selectedEvaluationForEdit}
                            onBack={() => {
                                setSelectedEvaluationForEdit(null);
                                setScreen('myEvaluations');
                            }}
                        />
                    )}

                    {screen === 'editEvaluation' && selectedEvaluationForEdit && (
                        <EvaluationScreen
                            subject={selectedSubject}
                            isSelf={selectedSubject?.id === currentUser?.code}
                            onSubmit={handleUpdateEvaluation}
                            onBack={() => {
                                setSelectedEvaluationForEdit(null);
                                setScreen('myEvaluations');
                            }}
                            isLoading={isLoading}
                            editMode={true}
                            existingData={selectedEvaluationForEdit}
                        />
                    )}
                </div>
            );
        };
        
        // ============================================
        // LOGIN SCREEN
        // ============================================
        const LoginScreen = ({ onLogin, isLoading, error }) => {
            const [code, setCode] = useState('');
            const [showForgotCode, setShowForgotCode] = useState(false);
            const [forgotEmail, setForgotEmail] = useState('');
            const [forgotStatus, setForgotStatus] = useState(null);
            const [forgotError, setForgotError] = useState('');

            const handleForgotCode = async () => {
                if (!forgotEmail.trim()) {
                    setForgotError('Voer asseblief jou e-pos adres in');
                    return;
                }
                setForgotStatus('sending');
                setForgotError('');
                try {
                    const result = await apiCall('forgotCode', { email: forgotEmail.trim() });
                    if (result.success) {
                        setForgotStatus('success');
                    } else {
                        setForgotStatus('error');
                        setForgotError(result.error || 'Kon nie e-pos stuur nie');
                    }
                } catch (e) {
                    setForgotStatus('error');
                    setForgotError('Netwerkfout - probeer weer');
                }
            };

            const closeForgotModal = () => {
                setShowForgotCode(false);
                setForgotEmail('');
                setForgotStatus(null);
                setForgotError('');
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (code.length === 5) {
                    onLogin(code);
                }
            };

            const handleCodeChange = (e) => {
                const value = e.target.value.replace(/\D/g, '').slice(0, 5);
                setCode(value);
            };

            return (
                <div className="min-h-screen min-h-[100dvh] flex items-center justify-center p-6 safe-top safe-bottom">
                    {/* Login Card */}
                    <div className="w-full max-w-sm bg-white rounded-3xl shadow-2xl p-8 animate-fade-in">
                        {/* Logo */}
                        <div className="flex justify-center mb-6">
                            <div className="w-20 h-20 rounded-full bg-gradient-gold flex items-center justify-center shadow-lg">
                                <Icons.Shield size={40} className="text-slate-900" />
                            </div>
                        </div>

                        {/* Title */}
                        <h1 className="font-display text-2xl text-slate-800 text-center mb-1">Oostagri Leierskap</h1>
                        <p className="text-slate-500 text-center mb-8">Meld aan met jou unieke kode</p>

                        {/* Form */}
                        <form onSubmit={handleSubmit}>
                            <label className="block text-slate-700 text-sm font-medium mb-2">
                                Voer Jou 5-Syfer Kode In
                            </label>
                            <input
                                type="text"
                                inputMode="numeric"
                                value={code}
                                onChange={handleCodeChange}
                                placeholder="•••••"
                                maxLength={5}
                                className="w-full p-4 text-center text-2xl tracking-[0.5em] bg-slate-100 border-2 border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 focus:border-amber-500 focus:bg-white mb-4"
                                disabled={isLoading}
                                autoFocus
                            />

                            {error && (
                                <p className="text-red-500 text-sm text-center mb-4">{error}</p>
                            )}

                            <button
                                type="submit"
                                disabled={code.length !== 5 || isLoading}
                                className="w-full py-4 bg-gradient-gold text-slate-900 rounded-xl font-bold text-lg hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {isLoading ? (
                                    <span className="flex items-center justify-center gap-2">
                                        <div className="w-5 h-5 border-2 border-slate-900 border-t-transparent rounded-full animate-spin"></div>
                                        Meld aan...
                                    </span>
                                ) : (
                                    'Meld Aan'
                                )}
                            </button>
                        </form>

                        {/* Forgot Code Link */}
                        <div className="text-center mt-6">
                            <button
                                onClick={() => setShowForgotCode(true)}
                                className="text-amber-600 hover:text-amber-700 text-sm font-medium transition"
                            >
                                Kode vergeet?
                            </button>
                        </div>
                    </div>

                    {/* Vergeet Kode Modal */}
                    {showForgotCode && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-6 z-50" onClick={closeForgotModal}>
                            <div className="bg-white rounded-2xl p-6 max-w-sm w-full animate-fade-in" onClick={e => e.stopPropagation()}>
                                {forgotStatus === 'success' ? (
                                    <div className="text-center">
                                        <Icons.CheckCircle size={48} className="mx-auto text-emerald-500 mb-4" />
                                        <h3 className="text-slate-800 font-display text-xl mb-3">E-pos Gestuur!</h3>
                                        <p className="text-slate-500 text-sm mb-6">
                                            Jou toegangskode is na <span className="text-slate-800 font-medium">{forgotEmail}</span> gestuur. Kyk ook in jou spam vouer.
                                        </p>
                                        <button
                                            onClick={closeForgotModal}
                                            className="w-full py-3 bg-gradient-gold text-slate-900 rounded-xl font-bold hover:opacity-90 transition"
                                        >
                                            Terug na Aanmeld
                                        </button>
                                    </div>
                                ) : (
                                    <div className="text-center">
                                        <Icons.User size={40} className="mx-auto text-amber-500 mb-4" />
                                        <h3 className="text-slate-800 font-display text-xl mb-3">Kode Vergeet?</h3>
                                        <p className="text-slate-500 text-sm mb-6">
                                            Voer jou e-pos adres in en ons sal jou kode vir jou stuur.
                                        </p>
                                        <input
                                            type="email"
                                            value={forgotEmail}
                                            onChange={(e) => setForgotEmail(e.target.value)}
                                            placeholder="jou@epos.co.za"
                                            className="w-full p-4 bg-slate-100 border-2 border-slate-200 rounded-xl text-slate-800 placeholder-slate-400 mb-4 focus:border-amber-500 focus:bg-white"
                                            disabled={forgotStatus === 'sending'}
                                        />
                                        {forgotError && (
                                            <p className="text-red-500 text-sm mb-4">{forgotError}</p>
                                        )}
                                        <button
                                            onClick={handleForgotCode}
                                            disabled={forgotStatus === 'sending'}
                                            className="w-full py-3 bg-gradient-gold text-slate-900 rounded-xl font-bold hover:opacity-90 transition disabled:opacity-50 mb-3"
                                        >
                                            {forgotStatus === 'sending' ? (
                                                <span className="flex items-center justify-center gap-2">
                                                    <div className="w-5 h-5 border-2 border-slate-900 border-t-transparent rounded-full animate-spin"></div>
                                                    Stuur...
                                                </span>
                                            ) : (
                                                'Stuur My Kode'
                                            )}
                                        </button>
                                        <button
                                            onClick={closeForgotModal}
                                            className="w-full py-2 text-slate-500 hover:text-slate-700 text-sm transition"
                                        >
                                            Kanselleer
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ============================================
        // NO CYCLE SCREEN
        // ============================================
        const NoCycleScreen = ({ user, onLogout }) => (
            <div className="min-h-screen min-h-[100dvh] flex flex-col items-center justify-center p-6 safe-top safe-bottom">
                <div className="text-center">
                    <Icons.Clock size={64} className="mx-auto text-slate-500 mb-6" />
                    <h2 className="font-display text-2xl text-white mb-4">Geen Oop Siklus</h2>
                    <p className="text-slate-400 mb-8 max-w-xs">
                        Daar is tans geen aktiewe evaluasiesiklus nie. Probeer weer later.
                    </p>
                    <button
                        onClick={onLogout}
                        className="px-6 py-3 bg-slate-700 text-white rounded-xl hover:bg-slate-600 transition"
                    >
                        Teken Uit
                    </button>
                </div>
            </div>
        );
        
        // ============================================
        // DASHBOARD SCREEN
        // ============================================
        const DashboardScreen = ({
            user, cycle, subjects, completedSubjects, progress,
            subordinates, completedSubordinates, currentMonth,
            onStartEvaluation, onStartMelkstalEvaluation, onLogout, onRefresh, isLoading, onViewHistory, historyCount
        }) => {
            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (progress.percentage / 100) * circumference;

            // Format month for display
            const formatMonth = (monthId) => {
                if (!monthId) return '';
                const [year, month] = monthId.split('-');
                const months = ['Januarie', 'Februarie', 'Maart', 'April', 'Mei', 'Junie',
                               'Julie', 'Augustus', 'September', 'Oktober', 'November', 'Desember'];
                return `${months[parseInt(month) - 1]} ${year}`;
            };

            // Calculate subordinate progress
            const subProgress = {
                done: completedSubordinates?.length || 0,
                total: subordinates?.length || 0,
                percentage: subordinates?.length > 0
                    ? Math.round((completedSubordinates?.length || 0) / subordinates.length * 100)
                    : 0
            };

            return (
                <div className="min-h-screen min-h-[100dvh] pb-6">
                    {/* Header */}
                    <div className="bg-gradient-card p-6 pb-8 rounded-b-3xl safe-top">
                        <div className="flex items-center justify-between mb-8">
                            <div>
                                <p className="text-slate-400 text-base mb-1">Welkom terug</p>
                                <h1 className="font-display text-3xl text-white">{user.name}</h1>
                            </div>
                            <button onClick={onLogout} className="p-4 rounded-xl bg-slate-800/50 hover:bg-slate-700 transition">
                                <Icons.LogOut size={24} className="text-slate-400" />
                            </button>
                        </div>

                        {/* Cycle Info */}
                        <div className="bg-slate-800/50 rounded-2xl p-5 mb-6">
                            <div className="flex items-center gap-4">
                                <Icons.Clock size={28} className="text-amber-500" />
                                <div>
                                    <p className="text-white font-semibold text-xl">{cycle?.name}</p>
                                    <p className="text-slate-400 text-base">Huidige siklus</p>
                                </div>
                            </div>
                        </div>

                        {/* Progress Ring */}
                        <div className="flex items-center gap-8">
                            <div className="relative w-32 h-32">
                                <svg className="w-32 h-32 progress-ring">
                                    <circle
                                        cx="64" cy="64" r={radius}
                                        fill="none" stroke="#334155" strokeWidth="10"
                                    />
                                    <circle
                                        cx="64" cy="64" r={radius}
                                        fill="none" stroke="#f59e0b" strokeWidth="10"
                                        strokeLinecap="round"
                                        strokeDasharray={circumference}
                                        strokeDashoffset={offset}
                                        className="progress-ring-circle"
                                    />
                                </svg>
                                <div className="absolute inset-0 flex items-center justify-center">
                                    <span className="text-3xl font-bold text-white">{progress.percentage}%</span>
                                </div>
                            </div>
                            <div>
                                <p className="text-4xl font-bold text-white">{progress.done}/{progress.total}</p>
                                <p className="text-slate-400 text-lg">Evaluasies voltooi</p>
                                {progress.done === progress.total && progress.total > 0 && (
                                    <p className="text-emerald-400 text-base mt-2">✓ Alles klaar!</p>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Action Buttons */}
                    <div className="px-6 pt-6 flex gap-3">
                        <button
                            onClick={onRefresh}
                            disabled={isLoading}
                            className="flex-1 flex items-center justify-center gap-2 py-4 bg-slate-800 rounded-xl text-slate-300 text-lg font-medium hover:bg-slate-700 transition disabled:opacity-50"
                        >
                            <Icons.Refresh size={22} className={isLoading ? 'animate-spin' : ''} />
                            Verfris
                        </button>
                        {historyCount > 0 && (
                            <button
                                onClick={onViewHistory}
                                className="flex-1 flex items-center justify-center gap-2 py-4 bg-violet-600/20 border border-violet-600/30 rounded-xl text-violet-300 text-lg font-medium hover:bg-violet-600/30 transition"
                            >
                                <Icons.Clipboard size={18} />
                                My Evaluasies ({historyCount})
                            </button>
                        )}
                    </div>

                    {/* Mede-Topbestuurslede Section */}
                    <div className="px-6 pt-8">
                        <div className="flex items-center justify-between mb-5">
                            <h2 className="text-xl font-semibold text-white">Mede-Topbestuurslede</h2>
                            <span className="text-sm text-slate-400 bg-slate-800 px-3 py-1 rounded-full">Kwartaalliks</span>
                        </div>

                        <div className="space-y-4">
                            {subjects.map((subject, index) => {
                                const isCompleted = completedSubjects.includes(subject.id);
                                const isSelf = subject.id === user.code;

                                return (
                                    <button
                                        key={subject.id}
                                        onClick={() => !isCompleted && onStartEvaluation(subject)}
                                        disabled={isCompleted}
                                        className={`w-full flex items-center gap-4 p-5 rounded-2xl transition animate-fade-in ${
                                            isCompleted
                                                ? 'bg-slate-800/30 opacity-60'
                                                : 'bg-gradient-card hover:border-amber-500/50 border-2 border-transparent'
                                        }`}
                                        style={{ animationDelay: `${index * 0.05}s` }}
                                    >
                                        <div className={`w-14 h-14 rounded-xl flex items-center justify-center ${
                                            isSelf ? 'bg-violet-600/20' : 'bg-amber-500/20'
                                        }`}>
                                            {isCompleted ? (
                                                <Icons.CheckCircle size={28} className="text-emerald-400" />
                                            ) : (
                                                <Icons.User size={28} className={isSelf ? 'text-violet-400' : 'text-amber-400'} />
                                            )}
                                        </div>
                                        <div className="flex-1 text-left">
                                            <p className="text-white font-semibold text-lg">
                                                {subject.name}
                                                {isSelf && <span className="text-violet-400 text-base ml-2">(Self)</span>}
                                            </p>
                                            <p className="text-slate-400 text-base">
                                                {isCompleted ? 'Voltooi' : 'Tik om te evalueer'}
                                            </p>
                                        </div>
                                        {!isCompleted && (
                                            <Icons.ArrowRight size={24} className="text-slate-500" />
                                        )}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {/* My Span (Subordinates) Section */}
                    {subordinates && subordinates.length > 0 && (
                        <div className="px-6 pt-8">
                            <div className="flex items-center justify-between mb-5">
                                <h2 className="text-xl font-semibold text-white">My Span</h2>
                                <span className="text-sm text-emerald-400 bg-emerald-600/20 px-3 py-1 rounded-full">
                                    {formatMonth(currentMonth)}
                                </span>
                            </div>

                            {/* Subordinate Progress */}
                            {subProgress.total > 0 && (
                                <div className="bg-emerald-600/10 border border-emerald-600/30 rounded-xl p-4 mb-4">
                                    <div className="flex items-center justify-between">
                                        <span className="text-emerald-300">Maandelikse vordering</span>
                                        <span className="text-emerald-400 font-bold">{subProgress.done}/{subProgress.total}</span>
                                    </div>
                                    <div className="h-2 bg-slate-700 rounded-full mt-2 overflow-hidden">
                                        <div
                                            className="h-full bg-emerald-500 transition-all duration-500"
                                            style={{ width: `${subProgress.percentage}%` }}
                                        />
                                    </div>
                                </div>
                            )}

                            <div className="space-y-4">
                                {subordinates.map((sub, index) => {
                                    const isCompleted = completedSubordinates?.includes(sub.id);

                                    return (
                                        <button
                                            key={sub.id}
                                            onClick={() => !isCompleted && onStartMelkstalEvaluation(sub)}
                                            disabled={isCompleted}
                                            className={`w-full flex items-center gap-4 p-5 rounded-2xl transition animate-fade-in ${
                                                isCompleted
                                                    ? 'bg-slate-800/30 opacity-60'
                                                    : 'bg-gradient-card hover:border-emerald-500/50 border-2 border-transparent'
                                            }`}
                                            style={{ animationDelay: `${index * 0.05}s` }}
                                        >
                                            <div className="w-14 h-14 rounded-xl flex items-center justify-center bg-emerald-600/20">
                                                {isCompleted ? (
                                                    <Icons.CheckCircle size={28} className="text-emerald-400" />
                                                ) : (
                                                    <Icons.Users size={28} className="text-emerald-400" />
                                                )}
                                            </div>
                                            <div className="flex-1 text-left">
                                                <p className="text-white font-semibold text-lg">{sub.name}</p>
                                                <p className="text-slate-400 text-base">
                                                    {sub.location && <span className="text-emerald-400">{sub.location} • </span>}
                                                    {isCompleted ? 'Voltooi' : 'Tik om te evalueer'}
                                                </p>
                                            </div>
                                            {!isCompleted && (
                                                <Icons.ArrowRight size={24} className="text-slate-500" />
                                            )}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* Offline Queue Indicator */}
                    {OfflineQueue.count() > 0 && (
                        <div className="mx-6 mt-6 p-4 bg-amber-600/20 border border-amber-600/30 rounded-xl">
                            <div className="flex items-center gap-3">
                                <Icons.WifiOff size={20} className="text-amber-400" />
                                <div>
                                    <p className="text-amber-300 font-medium">{OfflineQueue.count()} in waglys</p>
                                    <p className="text-amber-400/70 text-sm">Sal sinkroniseer wanneer aanlyn</p>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // ============================================
        // EVALUATION SCREEN
        // ============================================
        const EvaluationScreen = ({ subject, isSelf, onSubmit, onBack, isLoading, editMode = false, existingData = null }) => {
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [answers, setAnswers] = useState(() => {
                // If in edit mode, pre-populate with existing data
                if (editMode && existingData) {
                    const initialAnswers = {};
                    QUESTIONS.forEach(q => {
                        initialAnswers[q.id] = {
                            grade: existingData.grades?.[q.id] || 0,
                            comment: existingData.comments?.[q.id] || ''
                        };
                    });
                    return initialAnswers;
                }
                return {};
            });
            const [showConfirm, setShowConfirm] = useState(false);
            
            const question = QUESTIONS[currentQuestion];
            const answer = answers[question.id] || { grade: 0, comment: '' };
            const isLastQuestion = currentQuestion === QUESTIONS.length - 1;
            const canProceed = answer.grade > 0;
            
            const setGrade = (grade) => {
                setAnswers({ ...answers, [question.id]: { ...answer, grade } });
            };
            
            const setComment = (comment) => {
                setAnswers({ ...answers, [question.id]: { ...answer, comment } });
            };
            
            const handleNext = () => {
                if (isLastQuestion) {
                    setShowConfirm(true);
                } else {
                    setCurrentQuestion(currentQuestion + 1);
                }
            };
            
            const handlePrev = () => {
                if (currentQuestion > 0) {
                    setCurrentQuestion(currentQuestion - 1);
                }
            };
            
            const handleSubmit = () => {
                const evalData = {};
                QUESTIONS.forEach(q => {
                    const a = answers[q.id] || { grade: 0, comment: '' };
                    evalData[`${q.id}Grade`] = a.grade;
                    evalData[`${q.id}Comment`] = a.comment;
                });
                onSubmit(evalData);
            };
            
            // Confirmation Modal
            if (showConfirm) {
                return (
                    <div className="min-h-screen min-h-[100dvh] flex items-center justify-center p-6 safe-top safe-bottom">
                        <div className="bg-gradient-card rounded-3xl p-6 max-w-sm w-full animate-fade-in">
                            <div className="text-center mb-6">
                                <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-amber-500/20 flex items-center justify-center">
                                    <Icons.Clipboard size={32} className="text-amber-400" />
                                </div>
                                <h2 className="font-display text-xl text-white mb-2">
                                    {editMode ? 'Bevestig Wysiging' : 'Bevestig Indiening'}
                                </h2>
                                <p className="text-slate-400">
                                    {editMode
                                        ? <>Jy is gereed om jou gewysigde evaluasie vir <span className="text-white font-medium">{subject.name}</span> te stoor.</>
                                        : <>Jy is gereed om jou evaluasie vir <span className="text-white font-medium">{subject.name}</span> in te dien.</>
                                    }
                                </p>
                            </div>
                            
                            {/* Summary */}
                            <div className="bg-slate-800/50 rounded-xl p-4 mb-6 max-h-48 overflow-y-auto">
                                {QUESTIONS.map((q, i) => {
                                    const a = answers[q.id] || { grade: 0 };
                                    return (
                                        <div key={q.id} className="flex items-center justify-between py-2 border-b border-slate-700 last:border-0">
                                            <span className="text-slate-400 text-sm">V{i + 1}</span>
                                            <div className="flex gap-1">
                                                {[1,2,3,4,5].map(n => (
                                                    <Icons.Star
                                                        key={n}
                                                        size={14}
                                                        filled={n <= a.grade}
                                                        className={n <= a.grade ? 'text-amber-400' : 'text-slate-600'}
                                                    />
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            
                            <div className="flex gap-3">
                                <button
                                    onClick={() => setShowConfirm(false)}
                                    className="flex-1 py-4 bg-slate-700 text-white rounded-xl font-medium hover:bg-slate-600 transition"
                                >
                                    Terug
                                </button>
                                <button
                                    onClick={handleSubmit}
                                    disabled={isLoading}
                                    className="flex-1 py-4 bg-gradient-gold text-slate-900 rounded-xl font-bold hover:opacity-90 transition disabled:opacity-50"
                                >
                                    {isLoading ? 'Stoor...' : (editMode ? 'Stoor Wysigings' : 'Dien In')}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen min-h-[100dvh] flex flex-col safe-top safe-bottom">
                    {/* Header */}
                    <div className="p-4 flex items-center gap-4">
                        <button onClick={onBack} className="p-2 rounded-xl bg-slate-800 hover:bg-slate-700 transition">
                            <Icons.ArrowLeft size={24} className="text-slate-300" />
                        </button>
                        <div className="flex-1">
                            <p className="text-slate-400 text-sm">
                                {editMode ? 'Wysig Evaluasie' : 'Evalueer'}
                            </p>
                            <p className="text-white font-medium">
                                {subject.name}
                                {isSelf && <span className="text-violet-400 ml-2">(Self)</span>}
                            </p>
                        </div>
                        <div className="text-right">
                            <p className="text-amber-400 font-bold">{currentQuestion + 1}/7</p>
                            {editMode && (
                                <p className="text-violet-400 text-xs">wysig</p>
                            )}
                        </div>
                    </div>
                    
                    {/* Progress Bar */}
                    <div className="px-4 pb-4">
                        <div className="h-1 bg-slate-800 rounded-full overflow-hidden">
                            <div
                                className="h-full bg-gradient-gold transition-all duration-300"
                                style={{ width: `${((currentQuestion + 1) / 7) * 100}%` }}
                            />
                        </div>
                    </div>
                    
                    {/* Question */}
                    <div className="flex-1 px-4 pb-4 overflow-y-auto">
                        <div className="animate-fade-in" key={question.id}>
                            <h2 className="font-display text-xl text-white mb-3">{question.title}</h2>
                            <p className="text-slate-300 mb-4 leading-relaxed">{question.description}</p>
                            <p className="text-slate-500 text-sm mb-8 italic">{question.hint}</p>
                            
                            {/* Star Rating */}
                            <div className="mb-6">
                                <p className="text-slate-400 text-sm mb-3">Jou gradering:</p>
                                <div className="flex justify-center gap-2">
                                    {[1, 2, 3, 4, 5].map(n => (
                                        <button
                                            key={n}
                                            onClick={() => setGrade(n)}
                                            className={`p-3 rounded-xl transition star ${
                                                n <= answer.grade ? 'bg-amber-500/20' : 'bg-slate-800'
                                            }`}
                                        >
                                            <Icons.Star
                                                size={32}
                                                filled={n <= answer.grade}
                                                className={n <= answer.grade ? 'star-filled' : 'star-empty'}
                                            />
                                        </button>
                                    ))}
                                </div>
                                {answer.grade > 0 && (
                                    <p className="text-center mt-3 text-amber-400 font-medium animate-fade-in">
                                        {GRADE_LABELS[answer.grade]}
                                    </p>
                                )}
                            </div>
                            
                            {/* Comment */}
                            <div>
                                <label className="text-slate-400 text-sm mb-2 block">
                                    Opmerking (opsioneel):
                                </label>
                                <textarea
                                    value={answer.comment}
                                    onChange={(e) => setComment(e.target.value)}
                                    placeholder="Voeg enige opmerkings of voorbeelde by..."
                                    rows={3}
                                    className="w-full p-4 bg-slate-800 border-2 border-slate-700 rounded-xl text-white placeholder-slate-500 resize-none"
                                />
                            </div>
                        </div>
                    </div>
                    
                    {/* Navigation */}
                    <div className="p-4 bg-slate-900/80 backdrop-blur-sm">
                        <div className="flex gap-3">
                            <button
                                onClick={handlePrev}
                                disabled={currentQuestion === 0}
                                className="p-4 bg-slate-800 rounded-xl disabled:opacity-30 hover:bg-slate-700 transition"
                            >
                                <Icons.ArrowLeft size={24} className="text-white" />
                            </button>
                            <button
                                onClick={handleNext}
                                disabled={!canProceed}
                                className={`flex-1 py-4 rounded-xl font-bold text-lg transition ${
                                    canProceed
                                        ? 'bg-gradient-gold text-slate-900 hover:opacity-90'
                                        : 'bg-slate-800 text-slate-500'
                                }`}
                            >
                                {isLastQuestion ? 'Hersien & Dien In' : 'Volgende'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // MELKSTAL EVALUATION SCREEN
        // ============================================
        const MelkstalEvaluationScreen = ({ subject, onSubmit, onBack, isLoading, currentMonth }) => {
            const [currentSection, setCurrentSection] = useState(0);
            const [answers, setAnswers] = useState({});
            const [showConfirm, setShowConfirm] = useState(false);

            const section = MELKSTAL_SECTIONS[currentSection];
            const isLastSection = currentSection === MELKSTAL_SECTIONS.length - 1;

            // Check if a conditional question should be shown
            const shouldShowQuestion = (question) => {
                if (!question.conditional) return true;
                const [depId, depValue] = question.conditional.split(':');
                return answers[depId] === depValue;
            };

            // Get visible questions for current section
            const visibleQuestions = section.questions.filter(shouldShowQuestion);

            // Check if section is complete
            const isSectionComplete = () => {
                return visibleQuestions.every(q => {
                    const answer = answers[q.id];
                    if (q.type === 'text' || q.type === 'textarea') {
                        // Text fields are optional unless it's a conditional that's shown
                        if (q.conditional) {
                            const [depId, depValue] = q.conditional.split(':');
                            if (answers[depId] === depValue) return !!answer;
                        }
                        return true;
                    }
                    if (q.type === 'multirating') {
                        return q.items.every((_, i) => answers[`${q.id}_${i}`] > 0);
                    }
                    return !!answer;
                });
            };

            // Update answer
            const setAnswer = (questionId, value) => {
                setAnswers(prev => ({ ...prev, [questionId]: value }));
            };

            // Navigate sections
            const nextSection = () => {
                if (isLastSection) {
                    setShowConfirm(true);
                } else {
                    setCurrentSection(prev => prev + 1);
                    window.scrollTo(0, 0);
                }
            };

            const prevSection = () => {
                if (currentSection > 0) {
                    setCurrentSection(prev => prev - 1);
                    window.scrollTo(0, 0);
                }
            };

            // Submit
            const handleSubmit = () => {
                const data = { ...answers };
                onSubmit(data);
            };

            // Format month for display
            const formatMonth = (monthId) => {
                if (!monthId) return '';
                const [year, month] = monthId.split('-');
                const months = ['Januarie', 'Februarie', 'Maart', 'April', 'Mei', 'Junie',
                               'Julie', 'Augustus', 'September', 'Oktober', 'November', 'Desember'];
                return `${months[parseInt(month) - 1]} ${year}`;
            };

            // Render question based on type
            const renderQuestion = (question, index) => {
                const answer = answers[question.id];

                switch (question.type) {
                    case 'yesno':
                        return (
                            <div key={question.id} className="bg-gradient-card rounded-xl p-5 mb-4">
                                <p className="text-white font-medium text-lg mb-4">{question.title}</p>
                                {question.hint && <p className="text-slate-400 text-sm mb-4">{question.hint}</p>}
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setAnswer(question.id, 'Ja')}
                                        className={`flex-1 py-4 rounded-xl text-lg font-medium transition ${
                                            answer === 'Ja'
                                                ? 'bg-emerald-600 text-white'
                                                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                        }`}
                                    >
                                        Ja
                                    </button>
                                    <button
                                        onClick={() => setAnswer(question.id, 'Nee')}
                                        className={`flex-1 py-4 rounded-xl text-lg font-medium transition ${
                                            answer === 'Nee'
                                                ? 'bg-red-600 text-white'
                                                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                        }`}
                                    >
                                        Nee
                                    </button>
                                </div>
                            </div>
                        );

                    case 'yesnoNA':
                        return (
                            <div key={question.id} className="bg-gradient-card rounded-xl p-5 mb-4">
                                <p className="text-white font-medium text-lg mb-4">{question.title}</p>
                                {question.hint && <p className="text-slate-400 text-sm mb-4">{question.hint}</p>}
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setAnswer(question.id, 'Ja')}
                                        className={`flex-1 py-4 rounded-xl text-base font-medium transition ${
                                            answer === 'Ja'
                                                ? 'bg-emerald-600 text-white'
                                                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                        }`}
                                    >
                                        Ja
                                    </button>
                                    <button
                                        onClick={() => setAnswer(question.id, 'Nee')}
                                        className={`flex-1 py-4 rounded-xl text-base font-medium transition ${
                                            answer === 'Nee'
                                                ? 'bg-red-600 text-white'
                                                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                        }`}
                                    >
                                        Nee
                                    </button>
                                    <button
                                        onClick={() => setAnswer(question.id, 'N/A')}
                                        className={`flex-1 py-4 rounded-xl text-base font-medium transition ${
                                            answer === 'N/A'
                                                ? 'bg-slate-500 text-white'
                                                : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                        }`}
                                    >
                                        N/A
                                    </button>
                                </div>
                            </div>
                        );

                    case 'choice':
                        return (
                            <div key={question.id} className="bg-gradient-card rounded-xl p-5 mb-4">
                                <p className="text-white font-medium text-lg mb-4">{question.title}</p>
                                <div className="space-y-2">
                                    {question.options.map((option, i) => (
                                        <button
                                            key={i}
                                            onClick={() => setAnswer(question.id, option)}
                                            className={`w-full py-4 px-4 rounded-xl text-left text-base font-medium transition ${
                                                answer === option
                                                    ? 'bg-amber-600 text-white'
                                                    : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                            }`}
                                        >
                                            {option}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        );

                    case 'rating':
                        return (
                            <div key={question.id} className="bg-gradient-card rounded-xl p-5 mb-4">
                                <p className="text-white font-medium text-lg mb-4">{question.title}</p>
                                <div className="space-y-2">
                                    {question.labels.map((label, i) => (
                                        <button
                                            key={i}
                                            onClick={() => setAnswer(question.id, i + 1)}
                                            className={`w-full py-4 px-4 rounded-xl text-left transition flex items-center gap-3 ${
                                                answer === i + 1
                                                    ? 'bg-amber-600 text-white'
                                                    : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                                            }`}
                                        >
                                            <span className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                                                answer === i + 1 ? 'bg-white/20' : 'bg-slate-600'
                                            }`}>{i + 1}</span>
                                            <span className="text-base">{label}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        );

                    case 'multirating':
                        return (
                            <div key={question.id} className="bg-gradient-card rounded-xl p-5 mb-4">
                                <p className="text-white font-medium text-lg mb-4">{question.title}</p>
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr>
                                                <th className="text-left text-slate-400 text-sm pb-3"></th>
                                                {question.labels.map((label, i) => (
                                                    <th key={i} className="text-center text-slate-400 text-xs pb-3 px-1 min-w-[50px]">
                                                        {i + 1}
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {question.items.map((item, itemIndex) => (
                                                <tr key={itemIndex} className="border-t border-slate-700">
                                                    <td className="text-slate-300 text-sm py-3 pr-3">{item}</td>
                                                    {question.labels.map((_, ratingIndex) => (
                                                        <td key={ratingIndex} className="text-center py-3">
                                                            <button
                                                                onClick={() => setAnswer(`${question.id}_${itemIndex}`, ratingIndex + 1)}
                                                                className={`w-10 h-10 rounded-full transition ${
                                                                    answers[`${question.id}_${itemIndex}`] === ratingIndex + 1
                                                                        ? 'bg-amber-500 text-white'
                                                                        : 'bg-slate-700 text-slate-400 hover:bg-slate-600'
                                                                }`}
                                                            >
                                                                {ratingIndex + 1}
                                                            </button>
                                                        </td>
                                                    ))}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    <div className="flex justify-between text-xs text-slate-500 mt-2 px-1">
                                        <span>{question.labels[0]}</span>
                                        <span>{question.labels[question.labels.length - 1]}</span>
                                    </div>
                                </div>
                            </div>
                        );

                    case 'text':
                        return (
                            <div key={question.id} className="bg-gradient-card rounded-xl p-5 mb-4">
                                <p className="text-white font-medium text-lg mb-4">{question.title}</p>
                                <input
                                    type="text"
                                    value={answer || ''}
                                    onChange={(e) => setAnswer(question.id, e.target.value)}
                                    className="w-full p-4 bg-slate-700 border-2 border-slate-600 rounded-xl text-white text-base focus:outline-none focus:border-amber-500 transition"
                                    placeholder="Tik hier..."
                                />
                            </div>
                        );

                    case 'textarea':
                        return (
                            <div key={question.id} className="bg-gradient-card rounded-xl p-5 mb-4">
                                <p className="text-white font-medium text-lg mb-4">{question.title}</p>
                                <textarea
                                    value={answer || ''}
                                    onChange={(e) => setAnswer(question.id, e.target.value)}
                                    rows={4}
                                    className="w-full p-4 bg-slate-700 border-2 border-slate-600 rounded-xl text-white text-base focus:outline-none focus:border-amber-500 transition resize-none"
                                    placeholder="Tik hier..."
                                />
                            </div>
                        );

                    default:
                        return null;
                }
            };

            // Confirmation Modal
            if (showConfirm) {
                return (
                    <div className="min-h-screen min-h-[100dvh] flex items-center justify-center p-6 safe-top safe-bottom">
                        <div className="bg-gradient-card rounded-3xl p-6 max-w-sm w-full animate-fade-in">
                            <div className="text-center mb-6">
                                <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-emerald-500/20 flex items-center justify-center">
                                    <Icons.Clipboard size={32} className="text-emerald-400" />
                                </div>
                                <h2 className="font-display text-xl text-white mb-2">Bevestig Indiening</h2>
                                <p className="text-slate-400">
                                    Jy is gereed om die evaluasie vir <span className="text-white font-medium">{subject.name}</span> in te dien vir <span className="text-emerald-400">{formatMonth(currentMonth)}</span>.
                                </p>
                            </div>

                            <div className="flex gap-3">
                                <button
                                    onClick={() => setShowConfirm(false)}
                                    className="flex-1 py-4 bg-slate-700 text-white rounded-xl font-medium hover:bg-slate-600 transition"
                                >
                                    Terug
                                </button>
                                <button
                                    onClick={handleSubmit}
                                    disabled={isLoading}
                                    className="flex-1 py-4 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-500 transition disabled:opacity-50"
                                >
                                    {isLoading ? 'Stoor...' : 'Dien In'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen min-h-[100dvh] pb-32 safe-top safe-bottom">
                    {/* Header */}
                    <div className="p-5 flex items-center gap-4 bg-gradient-card sticky top-0 z-10">
                        <button onClick={onBack} className="p-3 rounded-xl bg-slate-800 hover:bg-slate-700 transition">
                            <Icons.ArrowLeft size={24} className="text-slate-300" />
                        </button>
                        <div className="flex-1">
                            <p className="text-emerald-400 text-sm font-medium">{formatMonth(currentMonth)}</p>
                            <p className="text-white font-display text-xl">{subject.name}</p>
                        </div>
                        <div className="text-right">
                            <p className="text-amber-400 font-bold">{currentSection + 1}/{MELKSTAL_SECTIONS.length}</p>
                        </div>
                    </div>

                    {/* Section Progress */}
                    <div className="px-6 pt-4">
                        <div className="flex gap-1 mb-2">
                            {MELKSTAL_SECTIONS.map((s, i) => (
                                <div
                                    key={s.id}
                                    className={`flex-1 h-1.5 rounded-full transition ${
                                        i < currentSection ? 'bg-emerald-500' :
                                        i === currentSection ? 'bg-amber-500' : 'bg-slate-700'
                                    }`}
                                />
                            ))}
                        </div>
                        <h2 className="text-xl font-semibold text-white mt-4 mb-2">{section.title}</h2>
                    </div>

                    {/* Questions */}
                    <div className="px-6 pt-4">
                        {visibleQuestions.map((q, i) => renderQuestion(q, i))}
                    </div>

                    {/* Navigation */}
                    <div className="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-slate-900 via-slate-900/95 to-transparent">
                        <div className="flex gap-3 max-w-lg mx-auto">
                            {currentSection > 0 && (
                                <button
                                    onClick={prevSection}
                                    className="flex-1 py-4 bg-slate-700 text-white rounded-xl font-medium text-lg hover:bg-slate-600 transition"
                                >
                                    Vorige
                                </button>
                            )}
                            <button
                                onClick={nextSection}
                                disabled={!isSectionComplete()}
                                className={`flex-1 py-4 rounded-xl font-bold text-lg transition ${
                                    isSectionComplete()
                                        ? 'bg-emerald-600 text-white hover:bg-emerald-500'
                                        : 'bg-slate-700 text-slate-500 cursor-not-allowed'
                                }`}
                            >
                                {isLastSection ? 'Voltooi' : 'Volgende'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // ============================================
        // SUCCESS SCREEN
        // ============================================
        const SuccessScreen = ({ subject, onContinue }) => (
            <div className="min-h-screen min-h-[100dvh] flex flex-col items-center justify-center p-6 safe-top safe-bottom">
                <div className="text-center animate-fade-in">
                    <div className="w-24 h-24 mx-auto mb-6 rounded-full bg-gradient-success flex items-center justify-center animate-pulse-gold">
                        <Icons.CheckCircle size={48} className="text-white" />
                    </div>
                    <h1 className="font-display text-3xl text-white mb-4">Dankie!</h1>
                    <p className="text-slate-400 mb-2">Jou evaluasie vir</p>
                    <p className="text-xl text-white font-medium mb-8">{subject?.name}</p>
                    <p className="text-slate-400 mb-8">is suksesvol gestoor.</p>
                    
                    <button
                        onClick={onContinue}
                        className="px-8 py-4 bg-gradient-gold text-slate-900 rounded-xl font-bold text-lg hover:opacity-90 transition"
                    >
                        Gaan Voort
                    </button>
                </div>
            </div>
        );
        
        // ============================================
        // COACH DASHBOARD
        // ============================================
        const CoachDashboard = ({ user, cycle, data, onSelectPerson, onLogout, onRefresh, isLoading }) => {
            const [sortBy, setSortBy] = useState('name'); // 'name', 'score', 'gap'
            const [showExportModal, setShowExportModal] = useState(false);
            const [exportLoading, setExportLoading] = useState(false);

            // Export evaluations
            const handleExport = async (personId = null) => {
                setExportLoading(true);
                try {
                    const result = await apiCall('exportEvaluations', {
                        cycleId: cycle.id,
                        requesterId: user.code,
                        personId: personId // null = all, or specific person
                    });

                    if (result.success && result.evaluations) {
                        const exportData = result.evaluations.map(e => {
                            const row = {
                                'Siklus': cycle.name,
                                'Datum': e.submittedAt ? new Date(e.submittedAt).toLocaleDateString('af-ZA') : '',
                                'Evalueerder': e.evaluatorName || '',
                                'Onderwerp': e.subjectName || '',
                                'Self Evaluasie': e.isSelfEval ? 'Ja' : 'Nee'
                            };

                            QUESTIONS.forEach((q, i) => {
                                row[`V${i+1}: ${q.title}`] = e.grades?.[q.id] || '';
                                row[`V${i+1} Opmerking`] = e.comments?.[q.id] || '';
                            });

                            return row;
                        });

                        const filename = personId
                            ? `evaluasies_${personId}_${cycle.name.replace(/\s+/g, '_')}`
                            : `alle_evaluasies_${cycle.name.replace(/\s+/g, '_')}`;
                        exportToCSV(exportData, filename);
                        setShowExportModal(false);
                    } else {
                        alert(result.error || 'Kon nie eksporteer nie');
                    }
                } catch (e) {
                    alert('Fout tydens eksport: ' + e.message);
                } finally {
                    setExportLoading(false);
                }
            };

            if (!data) {
                return (
                    <div className="min-h-screen min-h-[100dvh] flex items-center justify-center">
                        <div className="w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin" />
                    </div>
                );
            }

            // Bereken span gemiddeld
            const validAverages = data.personSummaries.filter(p => p.overallAverage > 0);
            const teamAverage = validAverages.length > 0
                ? (validAverages.reduce((sum, p) => sum + p.overallAverage, 0) / validAverages.length).toFixed(1)
                : '-';

            // Bereken self vs portuur gaping
            const calculateGap = (person) => {
                if (!person.selfGrades || !person.averageGrades) return null;
                const selfValues = Object.values(person.selfGrades).filter(v => v > 0);
                const peerValues = Object.values(person.averageGrades).filter(v => v > 0);
                if (selfValues.length === 0 || peerValues.length === 0) return null;
                const selfScore = selfValues.reduce((a, b) => a + b, 0) / selfValues.length;
                const peerScore = peerValues.reduce((a, b) => a + b, 0) / peerValues.length;
                return (selfScore - peerScore).toFixed(1);
            };

            // Sorteer persone
            const sortedPersons = [...data.personSummaries].sort((a, b) => {
                if (sortBy === 'name') {
                    return a.subjectName.localeCompare(b.subjectName);
                } else if (sortBy === 'score') {
                    return (b.overallAverage || 0) - (a.overallAverage || 0);
                } else if (sortBy === 'gap') {
                    const gapA = Math.abs(parseFloat(calculateGap(a)) || 0);
                    const gapB = Math.abs(parseFloat(calculateGap(b)) || 0);
                    return gapB - gapA;
                }
                return 0;
            });

            return (
                <div className="min-h-screen min-h-[100dvh] pb-6">
                    {/* Header */}
                    <div className="bg-gradient-card p-6 pb-8 rounded-b-3xl safe-top">
                        <div className="flex items-center justify-between mb-6">
                            <div>
                                <div className="flex items-center gap-2 mb-2">
                                    <span className="px-3 py-1.5 bg-violet-600/30 text-violet-300 text-sm font-semibold rounded-lg">
                                        COACH
                                    </span>
                                </div>
                                <h1 className="font-display text-3xl text-white">{user.name}</h1>
                            </div>
                            <button onClick={onLogout} className="p-4 rounded-xl bg-slate-800/50 hover:bg-slate-700 transition">
                                <Icons.LogOut size={24} className="text-slate-400" />
                            </button>
                        </div>

                        {/* Cycle Info */}
                        <div className="bg-slate-800/50 rounded-2xl p-5 mb-6">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-4">
                                    <Icons.Clock size={28} className="text-amber-500" />
                                    <div>
                                        <p className="text-white font-semibold text-xl">{cycle?.name}</p>
                                        <p className="text-slate-400 text-base">Huidige siklus</p>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <p className="text-3xl font-bold text-white">{data.completionRate}%</p>
                                    <p className="text-slate-400 text-base">voltooi</p>
                                </div>
                            </div>
                        </div>

                        {/* Stats */}
                        <div className="grid grid-cols-4 gap-3">
                            <div className="bg-slate-800/50 rounded-xl p-4 text-center">
                                <p className="text-2xl font-bold text-white">{data.totalSubjects}</p>
                                <p className="text-slate-400 text-sm">Bestuurders</p>
                            </div>
                            <div className="bg-slate-800/50 rounded-xl p-4 text-center">
                                <p className="text-2xl font-bold text-emerald-400">{data.totalCompleted}</p>
                                <p className="text-slate-400 text-sm">Voltooi</p>
                            </div>
                            <div className="bg-slate-800/50 rounded-xl p-4 text-center">
                                <p className="text-2xl font-bold text-amber-400">{data.totalExpected - data.totalCompleted}</p>
                                <p className="text-slate-400 text-sm">Uitstaande</p>
                            </div>
                            <div className="bg-gradient-gold/20 border-2 border-amber-500/40 rounded-xl p-4 text-center">
                                <p className="text-2xl font-bold text-amber-400">{teamAverage}</p>
                                <p className="text-amber-300/70 text-sm">Span Gem.</p>
                            </div>
                        </div>
                    </div>

                    {/* Export Modal */}
                    {showExportModal && (
                        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                            <div className="bg-gradient-card rounded-2xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto">
                                <div className="flex items-center justify-between mb-6">
                                    <h3 className="text-xl font-bold text-white">Eksporteer na Excel</h3>
                                    <button onClick={() => setShowExportModal(false)} className="p-2 hover:bg-slate-700 rounded-lg">
                                        <Icons.ArrowLeft size={20} className="text-slate-400" />
                                    </button>
                                </div>

                                {exportLoading ? (
                                    <div className="text-center py-8">
                                        <div className="w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin mx-auto mb-4" />
                                        <p className="text-slate-400">Eksporteer data...</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        <button
                                            onClick={() => handleExport(null)}
                                            className="w-full p-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-medium flex items-center gap-3 transition"
                                        >
                                            <Icons.Download size={20} />
                                            Eksporteer Almal ({data.totalCompleted} evaluasies)
                                        </button>

                                        <p className="text-slate-400 text-sm pt-2">Of kies 'n spesifieke persoon:</p>

                                        {sortedPersons.map(person => (
                                            <button
                                                key={person.subjectId}
                                                onClick={() => handleExport(person.subjectId)}
                                                className="w-full p-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl flex items-center justify-between transition"
                                            >
                                                <span>{person.subjectName}</span>
                                                <span className="text-slate-400 text-sm">{person.peerEvalCount + (person.hasSelfEval ? 1 : 0)} eval.</span>
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Action Bar */}
                    <div className="px-6 pt-6 flex gap-3">
                        <button
                            onClick={onRefresh}
                            disabled={isLoading}
                            className="flex items-center justify-center gap-2 px-4 py-4 bg-slate-800 rounded-xl text-slate-300 text-base font-medium hover:bg-slate-700 transition disabled:opacity-50"
                        >
                            <Icons.Refresh size={20} className={isLoading ? 'animate-spin' : ''} />
                        </button>
                        <button
                            onClick={() => setShowExportModal(true)}
                            className="flex items-center justify-center gap-2 px-4 py-4 bg-emerald-600/20 border border-emerald-600/30 rounded-xl text-emerald-300 text-base font-medium hover:bg-emerald-600/30 transition"
                        >
                            <Icons.Download size={20} />
                            Excel
                        </button>
                        <div className="flex-1 flex bg-slate-800 rounded-xl overflow-hidden">
                            <button
                                onClick={() => setSortBy('name')}
                                className={`flex-1 py-4 text-base font-medium transition ${sortBy === 'name' ? 'bg-violet-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                Naam
                            </button>
                            <button
                                onClick={() => setSortBy('score')}
                                className={`flex-1 py-4 text-base font-medium transition ${sortBy === 'score' ? 'bg-violet-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                Telling
                            </button>
                            <button
                                onClick={() => setSortBy('gap')}
                                className={`flex-1 py-4 text-base font-medium transition ${sortBy === 'gap' ? 'bg-violet-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                Gaping
                            </button>
                        </div>
                    </div>

                    {/* Person List */}
                    <div className="px-6 pt-6">
                        <h2 className="text-xl font-semibold text-white mb-5">Individuele Resultate</h2>

                        <div className="space-y-4">
                            {sortedPersons.map((person, index) => {
                                const gap = calculateGap(person);
                                const hasLargeGap = gap && Math.abs(parseFloat(gap)) >= 1;

                                return (
                                    <button
                                        key={person.subjectId}
                                        onClick={() => onSelectPerson(person)}
                                        className="w-full flex items-center gap-4 p-5 bg-gradient-card rounded-2xl border-2 border-transparent hover:border-violet-500/50 transition animate-fade-in"
                                        style={{ animationDelay: `${index * 0.05}s` }}
                                    >
                                        <div className={`w-14 h-14 rounded-xl flex items-center justify-center ${
                                            person.overallAverage >= 4 ? 'bg-emerald-600/20' :
                                            person.overallAverage >= 3 ? 'bg-amber-600/20' :
                                            person.overallAverage > 0 ? 'bg-red-600/20' : 'bg-slate-700/50'
                                        }`}>
                                            <Icons.User size={28} className={
                                                person.overallAverage >= 4 ? 'text-emerald-400' :
                                                person.overallAverage >= 3 ? 'text-amber-400' :
                                                person.overallAverage > 0 ? 'text-red-400' : 'text-slate-500'
                                            } />
                                        </div>
                                        <div className="flex-1 text-left">
                                            <p className="text-white font-semibold text-lg">{person.subjectName}</p>
                                            <p className="text-slate-400 text-base">
                                                {person.peerEvalCount} evaluasies
                                                {person.hasSelfEval ? ' • ✓ Self' : ' • ✗ Self'}
                                            </p>
                                        </div>
                                        <div className="text-right mr-2">
                                            <p className={`text-3xl font-bold ${
                                                person.overallAverage >= 4 ? 'text-emerald-400' :
                                                person.overallAverage >= 3 ? 'text-amber-400' :
                                                person.overallAverage > 0 ? 'text-red-400' : 'text-slate-500'
                                            }`}>
                                                {person.overallAverage || '-'}
                                            </p>
                                            {gap && (
                                                <p className={`text-sm font-medium ${
                                                    hasLargeGap ? 'text-orange-400' : 'text-slate-500'
                                                }`}>
                                                    {parseFloat(gap) > 0 ? '+' : ''}{gap} gaping
                                                </p>
                                            )}
                                        </div>
                                        <Icons.ArrowRight size={24} className="text-slate-500" />
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // MY EVALUATIONS SCREEN (History)
        // ============================================
        const MyEvaluationsScreen = ({ evaluations, onBack, onEdit, onView }) => {
            // Helper to check if evaluation can be edited (within 24 hours)
            const canEdit = (evaluation) => {
                if (!evaluation.submittedAt) return false;
                const submittedTime = new Date(evaluation.submittedAt).getTime();
                const now = Date.now();
                const hoursDiff = (now - submittedTime) / (1000 * 60 * 60);
                return hoursDiff <= 24;
            };

            // Format date for display
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('af-ZA', {
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            // Calculate time remaining for edit
            const getTimeRemaining = (evaluation) => {
                if (!evaluation.submittedAt) return null;
                const submittedTime = new Date(evaluation.submittedAt).getTime();
                const deadline = submittedTime + (24 * 60 * 60 * 1000);
                const remaining = deadline - Date.now();
                if (remaining <= 0) return null;
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                return `${hours}u ${minutes}m`;
            };

            // Export my evaluations
            const handleExport = () => {
                if (evaluations.length === 0) {
                    alert('Geen evaluasies om te eksporteer nie');
                    return;
                }

                const exportData = evaluations.map(e => {
                    const row = {
                        'Datum': e.submittedAt ? new Date(e.submittedAt).toLocaleDateString('af-ZA') : '',
                        'Onderwerp': e.subjectName || '',
                        'Gemiddeld': e.averageGrade ? e.averageGrade.toFixed(1) : ''
                    };

                    QUESTIONS.forEach((q, i) => {
                        row[`V${i+1}: ${q.title}`] = e.grades?.[q.id] || '';
                        row[`V${i+1} Opmerking`] = e.comments?.[q.id] || '';
                    });

                    return row;
                });

                exportToCSV(exportData, `my_evaluasies_${new Date().toISOString().split('T')[0]}`);
            };

            return (
                <div className="min-h-screen min-h-[100dvh] pb-6 safe-top safe-bottom">
                    {/* Header */}
                    <div className="p-4 flex items-center gap-4 bg-gradient-card">
                        <button onClick={onBack} className="p-2 rounded-xl bg-slate-800 hover:bg-slate-700 transition">
                            <Icons.ArrowLeft size={24} className="text-slate-300" />
                        </button>
                        <div className="flex-1">
                            <h1 className="text-white font-display text-xl">My Evaluasies</h1>
                            <p className="text-slate-400 text-sm">Geskiedenis van jou voltooide evaluasies</p>
                        </div>
                        {evaluations.length > 0 && (
                            <button
                                onClick={handleExport}
                                className="p-2 rounded-xl bg-emerald-600/20 border border-emerald-600/30 hover:bg-emerald-600/30 transition"
                            >
                                <Icons.Download size={24} className="text-emerald-400" />
                            </button>
                        )}
                    </div>

                    {/* Info Banner */}
                    <div className="mx-6 mt-4 p-4 bg-amber-600/20 border border-amber-600/30 rounded-xl">
                        <div className="flex items-start gap-3">
                            <Icons.Clock size={20} className="text-amber-400 mt-0.5" />
                            <p className="text-amber-200 text-sm">
                                Jy kan evaluasies binne 24 uur na indiening wysig.
                            </p>
                        </div>
                    </div>

                    {/* Evaluations List */}
                    <div className="px-6 pt-6">
                        {evaluations.length === 0 ? (
                            <div className="text-center py-12">
                                <Icons.Clipboard size={48} className="mx-auto text-slate-600 mb-4" />
                                <p className="text-slate-400">Geen evaluasies nog voltooi nie</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {evaluations.map((evaluation, index) => {
                                    const editable = canEdit(evaluation);
                                    const timeRemaining = getTimeRemaining(evaluation);

                                    return (
                                        <div
                                            key={evaluation.id || index}
                                            className="bg-gradient-card rounded-2xl p-4 animate-fade-in"
                                            style={{ animationDelay: `${index * 0.05}s` }}
                                        >
                                            <div className="flex items-start justify-between mb-3">
                                                <div>
                                                    <p className="text-white font-medium">{evaluation.subjectName}</p>
                                                    <p className="text-slate-400 text-sm">{formatDate(evaluation.submittedAt)}</p>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-amber-400 font-bold">{evaluation.averageGrade?.toFixed(1) || '-'}</p>
                                                    <p className="text-slate-500 text-xs">gemiddeld</p>
                                                </div>
                                            </div>

                                            {/* Grade Summary */}
                                            <div className="flex gap-1 mb-3">
                                                {QUESTIONS.map((q, i) => {
                                                    const grade = evaluation.grades?.[q.id] || 0;
                                                    return (
                                                        <div
                                                            key={q.id}
                                                            className={`flex-1 h-2 rounded-full ${
                                                                grade >= 4 ? 'bg-emerald-500' :
                                                                grade >= 3 ? 'bg-amber-500' :
                                                                grade >= 1 ? 'bg-red-500' : 'bg-slate-700'
                                                            }`}
                                                            title={`V${i+1}: ${grade}`}
                                                        />
                                                    );
                                                })}
                                            </div>

                                            {/* Actions */}
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => onView(evaluation)}
                                                    className="flex-1 py-2 bg-slate-800 text-slate-300 rounded-xl text-sm hover:bg-slate-700 transition"
                                                >
                                                    Bekyk
                                                </button>
                                                {editable ? (
                                                    <button
                                                        onClick={() => onEdit(evaluation)}
                                                        className="flex-1 py-2 bg-amber-600 text-white rounded-xl text-sm hover:bg-amber-500 transition flex items-center justify-center gap-2"
                                                    >
                                                        <Icons.Clock size={14} />
                                                        Wysig ({timeRemaining})
                                                    </button>
                                                ) : (
                                                    <div className="flex-1 py-2 bg-slate-800/50 text-slate-500 rounded-xl text-sm text-center">
                                                        Wysig tyd verstreke
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // ============================================
        // VIEW EVALUATION SCREEN (Read-only)
        // ============================================
        const ViewEvaluationScreen = ({ evaluation, onBack }) => {
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('af-ZA', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            return (
                <div className="min-h-screen min-h-[100dvh] pb-6 safe-top safe-bottom">
                    {/* Header */}
                    <div className="p-4 flex items-center gap-4 bg-gradient-card">
                        <button onClick={onBack} className="p-2 rounded-xl bg-slate-800 hover:bg-slate-700 transition">
                            <Icons.ArrowLeft size={24} className="text-slate-300" />
                        </button>
                        <div className="flex-1">
                            <p className="text-slate-400 text-sm">Evaluasie vir</p>
                            <h1 className="text-white font-display text-xl">{evaluation.subjectName}</h1>
                        </div>
                    </div>

                    {/* Meta info */}
                    <div className="px-6 pt-4">
                        <div className="bg-slate-800/50 rounded-xl p-4 mb-4">
                            <p className="text-slate-400 text-sm">Ingedien op</p>
                            <p className="text-white">{formatDate(evaluation.submittedAt)}</p>
                        </div>
                    </div>

                    {/* Questions and Answers */}
                    <div className="px-6 space-y-4">
                        {QUESTIONS.map((q, i) => {
                            const grade = evaluation.grades?.[q.id] || 0;
                            const comment = evaluation.comments?.[q.id] || '';

                            return (
                                <div key={q.id} className="bg-gradient-card rounded-2xl p-4">
                                    <div className="flex items-start justify-between mb-2">
                                        <div className="flex-1 pr-4">
                                            <p className="text-amber-400 text-sm font-medium mb-1">Vraag {i + 1}</p>
                                            <p className="text-white font-medium">{q.title}</p>
                                        </div>
                                        <div className="flex gap-1">
                                            {[1,2,3,4,5].map(n => (
                                                <Icons.Star
                                                    key={n}
                                                    size={16}
                                                    filled={n <= grade}
                                                    className={n <= grade ? 'text-amber-400' : 'text-slate-600'}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                    <p className="text-slate-500 text-sm mb-2">{GRADE_LABELS[grade]}</p>
                                    {comment && (
                                        <div className="mt-3 pt-3 border-t border-slate-700">
                                            <p className="text-slate-400 text-xs mb-1">Opmerking:</p>
                                            <p className="text-slate-300 text-sm italic">"{comment}"</p>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // ============================================
        // COACH DETAIL SCREEN
        // ============================================
        const CoachDetailScreen = ({ person, cycle, user, onBack }) => {
            const [detail, setDetail] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('scores'); // 'scores', 'comments'

            useEffect(() => {
                loadDetail();
            }, []);

            const loadDetail = async () => {
                setIsLoading(true);
                const result = await apiCall('getPersonDetail', {
                    subjectId: person.subjectId,
                    cycleId: cycle.id,
                    requesterId: user.code
                });
                if (result.success) {
                    setDetail(result.evaluations);
                }
                setIsLoading(false);
            };

            if (isLoading) {
                return (
                    <div className="min-h-screen min-h-[100dvh] flex items-center justify-center">
                        <div className="w-8 h-8 border-2 border-amber-500 border-t-transparent rounded-full animate-spin" />
                    </div>
                );
            }

            const peerEvals = detail?.filter(e => !e.isSelfEval) || [];
            const selfEval = detail?.find(e => e.isSelfEval);

            // Bereken self vs portuur gaping
            const selfValues = person.selfGrades ? Object.values(person.selfGrades).filter(v => v > 0) : [];
            const peerValues = person.averageGrades ? Object.values(person.averageGrades).filter(v => v > 0) : [];
            const selfAvg = selfValues.length > 0 ? (selfValues.reduce((a, b) => a + b, 0) / selfValues.length).toFixed(1) : null;
            const peerAvg = peerValues.length > 0 ? (peerValues.reduce((a, b) => a + b, 0) / peerValues.length).toFixed(1) : null;
            const gap = selfAvg && peerAvg ? (parseFloat(selfAvg) - parseFloat(peerAvg)).toFixed(1) : null;

            return (
                <div className="min-h-screen min-h-[100dvh] pb-6 safe-top safe-bottom">
                    {/* Header */}
                    <div className="p-5 flex items-center gap-4 bg-gradient-card">
                        <button onClick={onBack} className="p-3 rounded-xl bg-slate-800 hover:bg-slate-700 transition">
                            <Icons.ArrowLeft size={24} className="text-slate-300" />
                        </button>
                        <div className="flex-1">
                            <p className="text-violet-400 text-base font-medium">Coach Aansig</p>
                            <p className="text-white font-display text-2xl">{person.subjectName}</p>
                        </div>
                    </div>

                    {/* Summary Cards */}
                    <div className="px-6 pt-6">
                        <div className="grid grid-cols-3 gap-3 mb-6">
                            <div className="bg-gradient-card rounded-xl p-4 text-center">
                                <p className={`text-3xl font-bold ${
                                    person.overallAverage >= 4 ? 'text-emerald-400' :
                                    person.overallAverage >= 3 ? 'text-amber-400' : 'text-red-400'
                                }`}>{person.overallAverage || '-'}</p>
                                <p className="text-slate-400 text-sm">Portuur Gem.</p>
                            </div>
                            <div className="bg-gradient-card rounded-xl p-4 text-center">
                                <p className="text-3xl font-bold text-violet-400">{selfAvg || '-'}</p>
                                <p className="text-slate-400 text-sm">Self Gem.</p>
                            </div>
                            <div className={`bg-gradient-card rounded-xl p-4 text-center ${gap && Math.abs(parseFloat(gap)) >= 1 ? 'border-2 border-orange-500/50' : ''}`}>
                                <p className={`text-3xl font-bold ${
                                    gap && Math.abs(parseFloat(gap)) >= 1 ? 'text-orange-400' : 'text-slate-400'
                                }`}>{gap ? (parseFloat(gap) > 0 ? '+' : '') + gap : '-'}</p>
                                <p className="text-slate-400 text-sm">Gaping</p>
                            </div>
                        </div>

                        {/* Info */}
                        <div className="flex gap-4 mb-6 text-base">
                            <div className="flex items-center gap-2 text-slate-400">
                                <Icons.Users size={18} />
                                <span>{person.peerEvalCount} portuur evaluasies</span>
                            </div>
                            <div className="flex items-center gap-2 text-slate-400">
                                {person.hasSelfEval ? (
                                    <><Icons.CheckCircle size={18} className="text-emerald-400" /><span className="text-emerald-400">Self voltooi</span></>
                                ) : (
                                    <><Icons.Circle size={18} /><span>Self nie voltooi</span></>
                                )}
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="flex bg-slate-800 rounded-xl overflow-hidden mb-6">
                            <button
                                onClick={() => setActiveTab('scores')}
                                className={`flex-1 py-4 text-base font-medium transition ${activeTab === 'scores' ? 'bg-violet-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                Tellings per Vraag
                            </button>
                            <button
                                onClick={() => setActiveTab('comments')}
                                className={`flex-1 py-4 text-base font-medium transition ${activeTab === 'comments' ? 'bg-violet-600 text-white' : 'text-slate-400 hover:text-white'}`}
                            >
                                Opmerkings
                            </button>
                        </div>
                    </div>

                    {/* Scores Tab */}
                    {activeTab === 'scores' && (
                        <div className="px-6">
                            <div className="space-y-4">
                                {QUESTIONS.map((q, i) => {
                                    const avg = person.averageGrades?.[q.id] || 0;
                                    const selfScore = person.selfGrades?.[q.id] || 0;
                                    const barWidth = (avg / 5) * 100;
                                    const selfBarWidth = (selfScore / 5) * 100;
                                    const questionGap = selfScore && avg ? (selfScore - avg).toFixed(1) : null;

                                    return (
                                        <div key={q.id} className="bg-gradient-card rounded-xl p-5">
                                            <div className="flex justify-between items-start mb-3">
                                                <div className="flex-1 pr-4">
                                                    <p className="text-amber-400 text-sm font-medium mb-1">Vraag {i + 1}</p>
                                                    <p className="text-white font-medium text-base">{q.title}</p>
                                                </div>
                                                <div className="text-right">
                                                    <p className={`text-2xl font-bold ${
                                                        avg >= 4 ? 'text-emerald-400' :
                                                        avg >= 3 ? 'text-amber-400' :
                                                        avg > 0 ? 'text-red-400' : 'text-slate-500'
                                                    }`}>{avg || '-'}</p>
                                                </div>
                                            </div>
                                            {/* Peer bar */}
                                            <div className="mb-2">
                                                <div className="flex justify-between text-sm mb-1">
                                                    <span className="text-slate-400">Portuur</span>
                                                    <span className="text-slate-400">{avg}/5</span>
                                                </div>
                                                <div className="h-3 bg-slate-700 rounded-full overflow-hidden">
                                                    <div
                                                        className={`h-full transition-all duration-500 ${
                                                            avg >= 4 ? 'bg-emerald-500' :
                                                            avg >= 3 ? 'bg-amber-500' : 'bg-red-500'
                                                        }`}
                                                        style={{ width: `${barWidth}%` }}
                                                    />
                                                </div>
                                            </div>
                                            {/* Self bar */}
                                            {selfScore > 0 && (
                                                <div>
                                                    <div className="flex justify-between text-sm mb-1">
                                                        <span className="text-violet-400">Self</span>
                                                        <span className="text-violet-400">{selfScore}/5</span>
                                                    </div>
                                                    <div className="h-3 bg-slate-700 rounded-full overflow-hidden">
                                                        <div
                                                            className="h-full bg-violet-500 transition-all duration-500"
                                                            style={{ width: `${selfBarWidth}%` }}
                                                        />
                                                    </div>
                                                    {questionGap && Math.abs(parseFloat(questionGap)) >= 1 && (
                                                        <p className="text-orange-400 text-sm mt-2">
                                                            ⚠️ Gaping van {parseFloat(questionGap) > 0 ? '+' : ''}{questionGap}
                                                        </p>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* Comments Tab */}
                    {activeTab === 'comments' && (
                        <div className="px-6">
                            <div className="space-y-4">
                                {QUESTIONS.map(q => {
                                    const comments = peerEvals
                                        .map(e => e.comments?.[q.id])
                                        .filter(c => c && c.trim());

                                    if (comments.length === 0) return null;

                                    return (
                                        <div key={q.id} className="bg-gradient-card rounded-xl p-5">
                                            <p className="text-amber-400 text-base font-semibold mb-3">{q.title}</p>
                                            <div className="space-y-3">
                                                {comments.map((comment, i) => (
                                                    <p key={i} className="text-slate-300 text-base pl-4 border-l-3 border-slate-600 leading-relaxed">
                                                        "{comment}"
                                                    </p>
                                                ))}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    )}

                </div>
            );
        };
        
        // ============================================
        // RENDER APP
        // ============================================
        ReactDOM.createRoot(document.getElementById('root')).render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
